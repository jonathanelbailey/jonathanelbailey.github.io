
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      
        <link rel="prev" href="../../02/exploring-the-kubernetes-gateway-api-with-istio/">
      
      
      
        
      
      
      <link rel="icon" href="../../../../images/dumpster-fire.svg">
      <meta name="generator" content="mkdocs-1.4.3, mkdocs-material-9.1.17+insiders-4.36.1">
    
    
      
        <title>FQDN Field Validation with Pydantic - Magic City DevOps</title>
      
    
    
      <link rel="stylesheet" href="../../../../assets/stylesheets/main.cac7c1ad.min.css">
      
        
        <link rel="stylesheet" href="../../../../assets/stylesheets/palette.ecc776e4.min.css">
      
      

    
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
    <script>__md_scope=new URL("../../../..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
   <link href="../../../../assets/stylesheets/glightbox.min.css" rel="stylesheet"/><style>
        html.glightbox-open { overflow: initial; height: 100%; }
        .gslide-title { margin-top: 0px; user-select: text; }
        .gslide-desc { color: #666; user-select: text; }
        .gslide-image img { background: white; }
        
            .gscrollbar-fixer { padding-right: 15px; }
            .gdesc-inner { font-size: 0.75rem; }
            body[data-md-color-scheme="slate"] .gdesc-inner { background: var(--md-default-bg-color);}
            body[data-md-color-scheme="slate"] .gslide-title { color: var(--md-default-fg-color);}
            body[data-md-color-scheme="slate"] .gslide-desc { color: var(--md-default-fg-color);}
            </style> <script src="../../../../assets/javascripts/glightbox.min.js"></script></head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="indigo" data-md-color-accent="purple">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#fqdn-field-validation-with-pydantic" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../../../.." title="Magic City DevOps" class="md-header__button md-logo" aria-label="Magic City DevOps" data-md-component="logo">
      
  <img src="../../../../images/dumpster-fire.svg" alt="logo">

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Magic City DevOps
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              FQDN Field Validation with Pydantic
            
          </span>
        </div>
      </div>
    </div>
    
      
        <form class="md-header__option" data-md-component="palette">
          
            
            
            
            <input class="md-option" data-md-color-media="" data-md-color-scheme="default" data-md-color-primary="indigo" data-md-color-accent="purple"  aria-label="Switch to dark mode"  type="radio" name="__palette" id="__palette_0">
            
              <label class="md-header__button md-icon" title="Switch to dark mode" for="__palette_1" hidden>
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M17 6H7c-3.31 0-6 2.69-6 6s2.69 6 6 6h10c3.31 0 6-2.69 6-6s-2.69-6-6-6zm0 10H7c-2.21 0-4-1.79-4-4s1.79-4 4-4h10c2.21 0 4 1.79 4 4s-1.79 4-4 4zM7 9c-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3-1.34-3-3-3z"/></svg>
              </label>
            
          
            
            
            
            <input class="md-option" data-md-color-media="" data-md-color-scheme="slate" data-md-color-primary="indigo" data-md-color-accent="lime"  aria-label="Switch to light mode"  type="radio" name="__palette" id="__palette_1">
            
              <label class="md-header__button md-icon" title="Switch to light mode" for="__palette_0" hidden>
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M17 7H7a5 5 0 0 0-5 5 5 5 0 0 0 5 5h10a5 5 0 0 0 5-5 5 5 0 0 0-5-5m0 8a3 3 0 0 1-3-3 3 3 0 0 1 3-3 3 3 0 0 1 3 3 3 3 0 0 1-3 3Z"/></svg>
              </label>
            
          
        </form>
      
    
    
      <script>var media,input,key,value,palette=__md_get("__palette");if(palette&&palette.color){"(prefers-color-scheme)"===palette.color.media&&(media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']"),palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent"));for([key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
            
<nav class="md-tabs" aria-label="Tabs" data-md-component="tabs">
  <div class="md-grid">
    <ul class="md-tabs__list">
      
        
  
  
    
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../../.." class="md-tabs__link md-tabs__link--active">
          
  
  Blog

        </a>
      </li>
    
  

      
        
  
  
  
    
    
      
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../../../homelab/reference/ubuntu-server-homelab-configuration-guide/" class="md-tabs__link">
          
  
  Homelab

        </a>
      </li>
    
  

    
  

      
    </ul>
  </div>
</nav>
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
                
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" hidden>
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


  


  

<nav class="md-nav md-nav--primary md-nav--lifted md-nav--integrated" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../../../.." title="Magic City DevOps" class="md-nav__button md-logo" aria-label="Magic City DevOps" data-md-component="logo">
      
  <img src="../../../../images/dumpster-fire.svg" alt="logo">

    </a>
    Magic City DevOps
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
    
  
  
    
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
        
        
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_1" checked>
        
          <label class="md-nav__link" for="__nav_1" id="__nav_1_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    
  
    Blog
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_1_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_1">
            <span class="md-nav__icon md-icon"></span>
            
  
    Blog
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
    
  
  
    <li class="md-nav__item md-nav__item--active">
      <a href="../../../.." class="md-nav__link">
        
  
  <span class="md-ellipsis">
    
  
    Magic City DevOps
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
    
    
      
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
        
        
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_1_2" >
        
          <label class="md-nav__link" for="__nav_1_2" id="__nav_1_2_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    
  
    Archive
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_1_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_1_2">
            <span class="md-nav__icon md-icon"></span>
            
  
    Archive
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../../../archive/2023/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    
  
    2023
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
    
    
    
      
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
        
        
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_1_3" >
        
          <label class="md-nav__link" for="__nav_1_3" id="__nav_1_3_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    
  
    Categories
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_1_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_1_3">
            <span class="md-nav__icon md-icon"></span>
            
  
    Categories
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../../../category/ambient-mesh/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    
  
    Ambient Mesh
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../../../category/argocd/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    
  
    ArgoCD
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../../../category/blue-green/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    
  
    Blue Green
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../../../category/canary/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    
  
    Canary
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../../../category/cni/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    
  
    CNI
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../../../category/devops/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    
  
    DevOps
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../../../category/gateway-api/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    
  
    Gateway API
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../../../category/gitops/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    
  
    GitOps
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../../../category/istio/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    
  
    istio
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../../../category/kubernetes/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    
  
    Kubernetes
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../../../category/pydantic/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    
  
    pydantic
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../../../category/python/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    
  
    python
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../../../category/regex/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    
  
    regex
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../../../category/service-mesh/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    
  
    Service Mesh
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../../../category/tdd/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    
  
    TDD
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../../../category/ztunnel/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    
  
    Ztunnel
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2" >
        
          <label class="md-nav__link" for="__nav_2" id="__nav_2_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    
  
    Homelab
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2">
            <span class="md-nav__icon md-icon"></span>
            
  
    Homelab
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
    
    
    
      
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
        
        
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_1" >
        
          <label class="md-nav__link" for="__nav_2_1" id="__nav_2_1_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    
  
    Reference
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_2_1_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2_1">
            <span class="md-nav__icon md-icon"></span>
            
  
    Reference
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../../../homelab/reference/ubuntu-server-homelab-configuration-guide/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    
  
    Ubuntu Server Homelab Configuration Guide
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../../../homelab/reference/openstack-configuration-guide/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    
  
    Openstack Configuration Guide
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
          
          
  <div class="md-content md-content--post" data-md-component="content">
    <div class="md-sidebar md-sidebar--post" data-md-component="sidebar" data-md-type="navigation">
      <div class="md-sidebar__scrollwrap">
        <div class="md-sidebar__inner md-post">
          <nav class="md-nav">
            <div class="md-post__back">
              <div class="md-nav__title md-nav__container">
                <a href="../../../.." class="md-nav__link">
                  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
                  <span class="md-ellipsis">
                    Back to index
                  </span>
                </a>
              </div>
            </div>
            
              <div class="md-post__authors md-typeset">
                
                  <div class="md-profile md-post__profile">
                    <span class="md-author md-author--long">
                      <img src="https://avatars.githubusercontent.com/u/10998000" alt="Jonathan Bailey">
                    </span>
                    <span class="md-profile__description">
                      <strong>Jonathan Bailey</strong><br>
                      Creator
                    </span>
                  </div>
                
              </div>
            
            <ul class="md-post__meta md-nav__list">
              <li class="md-nav__item md-nav__title">
                <div class="md-nav__link">
                  <span class="md-ellipsis">
                    Metadata
                  </span>
                </div>
              </li>
              <li class="md-nav__item">
                <div class="md-nav__link">
                  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 19H5V8h14m-3-7v2H8V1H6v2H5c-1.11 0-2 .89-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V5a2 2 0 0 0-2-2h-1V1m-1 11h-5v5h5v-5Z"/></svg>
                  <time datetime="2023-07-26 00:00:00" class="md-ellipsis">July 26, 2023</time>
                </div>
              </li>
              
                <li class="md-nav__item">
                  <div class="md-nav__link">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9 3v15h3V3H9m3 2 4 13 3-1-4-13-3 1M5 5v13h3V5H5M3 19v2h18v-2H3Z"/></svg>
                    <span class="md-ellipsis">
                      in
                      
                        <a href="../../../../category/pydantic/">pydantic</a>, 
                        <a href="../../../../category/regex/">regex</a>, 
                        <a href="../../../../category/python/">python</a>, 
                        <a href="../../../../category/tdd/">TDD</a>, 
                        <a href="../../../../category/istio/">istio</a></span>
                  </div>
                </li>
              
              
                
                <li class="md-nav__item">
                  <div class="md-nav__link">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 20a8 8 0 0 0 8-8 8 8 0 0 0-8-8 8 8 0 0 0-8 8 8 8 0 0 0 8 8m0-18a10 10 0 0 1 10 10 10 10 0 0 1-10 10C6.47 22 2 17.5 2 12A10 10 0 0 1 12 2m.5 5v5.25l4.5 2.67-.75 1.23L11 13V7h1.5Z"/></svg>
                    <span class="md-ellipsis">
                      
                        13 min read
                      
                    </span>
                  </div>
                </li>
              
            </ul>
            
          </nav>
          
            

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#the-problem" class="md-nav__link">
    <span class="md-ellipsis">
      
        The Problem
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#the-solution" class="md-nav__link">
    <span class="md-ellipsis">
      
        The Solution
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#flake8-validation" class="md-nav__link">
    <span class="md-ellipsis">
      
        Flake8 Validation
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#breaking-up-the-regex" class="md-nav__link">
    <span class="md-ellipsis">
      
        Breaking Up the Regex
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#refactoring" class="md-nav__link">
    <span class="md-ellipsis">
      
        Refactoring
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#the-final-result" class="md-nav__link">
    <span class="md-ellipsis">
      
        The Final Result
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#conclusion" class="md-nav__link">
    <span class="md-ellipsis">
      
        Conclusion
      
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
          
        </div>
      </div>
    </div>
    <article class="md-content__inner md-typeset">
      
        


<h1 id="fqdn-field-validation-with-pydantic">FQDN Field Validation with Pydantic</h1>
<h2 id="the-problem">The Problem</h2>
<p>Customers were configuring egress entries for external services using incorrect syntax.  This would lead to validation errors from Istio when deploying microservice CRDs, so the controller that manages the CRD's owned resources would then begin generating errors when attempting to update resources that Istio's <code>validatingwebhook</code> would reject:</p>
<div class="highlight"><span class="filename">microserviceDeployment.yaml</span><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="nn">...</span>
<a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a><span class="nt">DeploymentStrategy</span><span class="p">:</span>
<a id="__codelineno-0-3" name="__codelineno-0-3" href="#__codelineno-0-3"></a><span class="w">  </span><span class="nt">ServiceDependencies</span><span class="p">:</span>
<a id="__codelineno-0-4" name="__codelineno-0-4" href="#__codelineno-0-4"></a><span class="w">    </span><span class="nt">egress</span><span class="p">:</span>
<a id="__codelineno-0-5" name="__codelineno-0-5" href="#__codelineno-0-5"></a><span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">hosts</span><span class="p">:</span>
<a id="__codelineno-0-6" name="__codelineno-0-6" href="#__codelineno-0-6"></a><span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">external/some-external-serviceentry</span><span class="w"> </span><span class="c1"># (1)</span>
</code></pre></div>
<ol>
<li>When the CRD is applied, various Istio resources are generated.  Istio's <code>DestinationRule</code> resource expects <code>host</code> values that reference <code>ServiceEntry</code> resources to be formatted as <code>namespace/service-entry-name.namespace.svc.cluster.local</code>.</li>
</ol>
<p>The microservice pipeline would validate that the field contained a list of strings:</p>
<div class="highlight"><span class="filename">src/service_dependency_schema.py</span><pre><span></span><code><a id="__codelineno-1-1" name="__codelineno-1-1" href="#__codelineno-1-1"></a><span class="kn">from</span> <span class="nn">pydantic</span> <span class="kn">import</span> <span class="n">BaseModel</span><span class="p">,</span> <span class="n">parse_obj_as</span>
<a id="__codelineno-1-2" name="__codelineno-1-2" href="#__codelineno-1-2"></a><span class="kn">from</span> <span class="nn">Faker</span> <span class="kn">import</span> <span class="n">Faker</span>
<a id="__codelineno-1-3" name="__codelineno-1-3" href="#__codelineno-1-3"></a><span class="kn">from</span> <span class="nn">faker.providers</span> <span class="kn">import</span> <span class="n">python</span>
<a id="__codelineno-1-4" name="__codelineno-1-4" href="#__codelineno-1-4"></a><span class="kn">import</span> <span class="nn">pytest</span>
<a id="__codelineno-1-5" name="__codelineno-1-5" href="#__codelineno-1-5"></a>
<a id="__codelineno-1-6" name="__codelineno-1-6" href="#__codelineno-1-6"></a><span class="k">class</span> <span class="nc">Egress</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">,</span> <span class="n">extra</span><span class="o">=</span><span class="s2">&quot;forbid&quot;</span><span class="p">):</span>
<a id="__codelineno-1-7" name="__codelineno-1-7" href="#__codelineno-1-7"></a>    <span class="n">port</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Port</span><span class="p">]</span>
<a id="__codelineno-1-8" name="__codelineno-1-8" href="#__codelineno-1-8"></a>    <span class="n">hosts</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span>
<a id="__codelineno-1-9" name="__codelineno-1-9" href="#__codelineno-1-9"></a>
<a id="__codelineno-1-10" name="__codelineno-1-10" href="#__codelineno-1-10"></a>
<a id="__codelineno-1-11" name="__codelineno-1-11" href="#__codelineno-1-11"></a><span class="n">fake</span> <span class="o">=</span> <span class="n">Faker</span><span class="p">()</span>
<a id="__codelineno-1-12" name="__codelineno-1-12" href="#__codelineno-1-12"></a><span class="n">fake</span><span class="o">.</span><span class="n">add_provider</span><span class="p">(</span><span class="n">python</span><span class="p">)</span>
<a id="__codelineno-1-13" name="__codelineno-1-13" href="#__codelineno-1-13"></a>
<a id="__codelineno-1-14" name="__codelineno-1-14" href="#__codelineno-1-14"></a>
<a id="__codelineno-1-15" name="__codelineno-1-15" href="#__codelineno-1-15"></a><span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
<a id="__codelineno-1-16" name="__codelineno-1-16" href="#__codelineno-1-16"></a><span class="k">def</span> <span class="nf">egress_data</span><span class="p">():</span>
<a id="__codelineno-1-17" name="__codelineno-1-17" href="#__codelineno-1-17"></a>    <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;hosts&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">pystr</span><span class="p">()]}</span>
<a id="__codelineno-1-18" name="__codelineno-1-18" href="#__codelineno-1-18"></a>
<a id="__codelineno-1-19" name="__codelineno-1-19" href="#__codelineno-1-19"></a>
<a id="__codelineno-1-20" name="__codelineno-1-20" href="#__codelineno-1-20"></a><span class="k">def</span> <span class="nf">test_egress_schema</span><span class="p">(</span><span class="n">egress_data</span><span class="p">):</span>
<a id="__codelineno-1-21" name="__codelineno-1-21" href="#__codelineno-1-21"></a>    <span class="c1"># when</span>
<a id="__codelineno-1-22" name="__codelineno-1-22" href="#__codelineno-1-22"></a>    <span class="n">parsed</span> <span class="o">=</span> <span class="n">parse_obj_as</span><span class="p">(</span><span class="n">Egress</span><span class="p">,</span> <span class="n">egress_data</span><span class="p">)</span>
<a id="__codelineno-1-23" name="__codelineno-1-23" href="#__codelineno-1-23"></a>
<a id="__codelineno-1-24" name="__codelineno-1-24" href="#__codelineno-1-24"></a>    <span class="c1"># then</span>
<a id="__codelineno-1-25" name="__codelineno-1-25" href="#__codelineno-1-25"></a>    <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">parsed</span><span class="o">.</span><span class="n">hosts</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span>
<a id="__codelineno-1-26" name="__codelineno-1-26" href="#__codelineno-1-26"></a>    <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">parsed</span><span class="o">.</span><span class="n">hosts</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nb">str</span><span class="p">)</span>
</code></pre></div>
<!-- more -->
<p>The pipeline should be able to fail builds with invalid configurations, so the <code>hosts</code> field validation required a refactor.</p>
<h2 id="the-solution">The Solution</h2>
<p>Validation of the <code>hosts</code> field is multi-faceted:</p>
<ol>
<li>The FQDN should meet <a href="https://www.ietf.org/rfc/rfc1035.txt">RFC1035</a> standards</li>
<li>Istio expects <code>namespace/</code> to prefix each fqdn</li>
<li><code>hosts</code> values that represent <code>ServiceEntry</code> resources need to be fully qualified</li>
</ol>
<p>Typically, this can be done using regex:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-2-1" name="__codelineno-2-1" href="#__codelineno-2-1"></a># This regex pattern validates FQDNs according to RFC1035:
<a id="__codelineno-2-2" name="__codelineno-2-2" href="#__codelineno-2-2"></a>^(?!:\/\/)(?=.{1,255}$)((.{1,63}\.){1,127}(?![0-9]*$)[a-z0-9-]+\.?)
<a id="__codelineno-2-3" name="__codelineno-2-3" href="#__codelineno-2-3"></a>
<a id="__codelineno-2-4" name="__codelineno-2-4" href="#__codelineno-2-4"></a># This regex pattern validates the namespace is prefixed to the fQDN:
<a id="__codelineno-2-5" name="__codelineno-2-5" href="#__codelineno-2-5"></a>external\/.+.svc.cluster.local
<a id="__codelineno-2-6" name="__codelineno-2-6" href="#__codelineno-2-6"></a>
<a id="__codelineno-2-7" name="__codelineno-2-7" href="#__codelineno-2-7"></a># This regex combines the two:
<a id="__codelineno-2-8" name="__codelineno-2-8" href="#__codelineno-2-8"></a>^\*\/(?!:\/\/)(?=.{1,255}$)((.{1,63}\.){1,127}(?![0-9]*$)[a-z0-9-]+\.?)|external\/.+.svc.cluster.local
</code></pre></div>
<p>Pydantic provides string constraint capabilities using <code>constr()</code>, which includes regex matching capabilities:</p>
<div class="highlight"><span class="filename">src/service_dependency_schema.py</span><pre><span></span><code><a id="__codelineno-3-1" name="__codelineno-3-1" href="#__codelineno-3-1"></a><span class="kn">from</span> <span class="nn">pydantic</span> <span class="kn">import</span> <span class="n">BaseModel</span><span class="p">,</span> <span class="n">constr</span><span class="p">,</span> <span class="n">ValidationError</span><span class="p">,</span> <span class="n">parse_obj_as</span>
<a id="__codelineno-3-2" name="__codelineno-3-2" href="#__codelineno-3-2"></a><span class="kn">from</span> <span class="nn">Faker</span> <span class="kn">import</span> <span class="n">Faker</span>
<a id="__codelineno-3-3" name="__codelineno-3-3" href="#__codelineno-3-3"></a><span class="kn">from</span> <span class="nn">faker.providers</span> <span class="kn">import</span> <span class="n">python</span>
<a id="__codelineno-3-4" name="__codelineno-3-4" href="#__codelineno-3-4"></a><span class="kn">import</span> <span class="nn">pytest</span>
<a id="__codelineno-3-5" name="__codelineno-3-5" href="#__codelineno-3-5"></a>
<a id="__codelineno-3-6" name="__codelineno-3-6" href="#__codelineno-3-6"></a><span class="k">class</span> <span class="nc">Egress</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">,</span> <span class="n">extra</span><span class="o">=</span><span class="s2">&quot;forbid&quot;</span><span class="p">):</span>
<a id="__codelineno-3-7" name="__codelineno-3-7" href="#__codelineno-3-7"></a>    <span class="c1"># Add regex</span>
<a id="__codelineno-3-8" name="__codelineno-3-8" href="#__codelineno-3-8"></a>    <span class="n">regex_pattern</span> <span class="o">=</span> <span class="s2">&quot;^\*\/(?!:\/\/)(?=.{1,255}$)((.{1,63}\.){1,127}(?![0-9]*$)[a-z0-9-]+\.?)|external\/.+.svc.cluster.local&quot;</span>
<a id="__codelineno-3-9" name="__codelineno-3-9" href="#__codelineno-3-9"></a>    <span class="n">port</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Port</span><span class="p">]</span>
<a id="__codelineno-3-10" name="__codelineno-3-10" href="#__codelineno-3-10"></a>    <span class="n">hosts</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">constr</span><span class="p">(</span><span class="n">regex</span><span class="o">=</span><span class="n">regex_pattern</span><span class="p">)]</span> <span class="c1"># (1)</span>
<a id="__codelineno-3-11" name="__codelineno-3-11" href="#__codelineno-3-11"></a>
<a id="__codelineno-3-12" name="__codelineno-3-12" href="#__codelineno-3-12"></a>
<a id="__codelineno-3-13" name="__codelineno-3-13" href="#__codelineno-3-13"></a><span class="n">fake</span> <span class="o">=</span> <span class="n">Faker</span><span class="p">()</span>
<a id="__codelineno-3-14" name="__codelineno-3-14" href="#__codelineno-3-14"></a><span class="n">fake</span><span class="o">.</span><span class="n">add_provider</span><span class="p">(</span><span class="n">python</span><span class="p">)</span>
<a id="__codelineno-3-15" name="__codelineno-3-15" href="#__codelineno-3-15"></a>
<a id="__codelineno-3-16" name="__codelineno-3-16" href="#__codelineno-3-16"></a>
<a id="__codelineno-3-17" name="__codelineno-3-17" href="#__codelineno-3-17"></a><span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
<a id="__codelineno-3-18" name="__codelineno-3-18" href="#__codelineno-3-18"></a><span class="k">def</span> <span class="nf">egress_data</span><span class="p">(</span><span class="n">valid</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span> <span class="c1"># (2)</span>
<a id="__codelineno-3-19" name="__codelineno-3-19" href="#__codelineno-3-19"></a>    <span class="k">if</span> <span class="n">valid</span><span class="p">:</span>
<a id="__codelineno-3-20" name="__codelineno-3-20" href="#__codelineno-3-20"></a>        <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;hosts&quot;</span><span class="p">:</span> <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;external/</span><span class="si">{</span><span class="n">fake</span><span class="o">.</span><span class="n">pystr</span><span class="p">()</span><span class="si">}</span><span class="s2">.</span><span class="si">{</span><span class="n">fake</span><span class="o">.</span><span class="n">pystr</span><span class="p">()</span><span class="si">}</span><span class="s2">.svc.cluster.local&quot;</span><span class="p">]}</span> <span class="c1"># (3)</span>
<a id="__codelineno-3-21" name="__codelineno-3-21" href="#__codelineno-3-21"></a>    <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-3-22" name="__codelineno-3-22" href="#__codelineno-3-22"></a>        <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;hosts&quot;</span><span class="p">:</span> <span class="p">[</span> <span class="c1"># (4)</span>
<a id="__codelineno-3-23" name="__codelineno-3-23" href="#__codelineno-3-23"></a>                <span class="sa">f</span><span class="s2">&quot;external/</span><span class="si">{</span><span class="n">fake</span><span class="o">.</span><span class="n">pystr</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
<a id="__codelineno-3-24" name="__codelineno-3-24" href="#__codelineno-3-24"></a>                <span class="sa">f</span><span class="s2">&quot;external/</span><span class="si">{</span><span class="n">fake</span><span class="o">.</span><span class="n">pystr</span><span class="p">()</span><span class="si">}</span><span class="s2">.</span><span class="si">{</span><span class="n">fake</span><span class="o">.</span><span class="n">pystr</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
<a id="__codelineno-3-25" name="__codelineno-3-25" href="#__codelineno-3-25"></a>                <span class="sa">f</span><span class="s2">&quot;external/</span><span class="si">{</span><span class="n">fake</span><span class="o">.</span><span class="n">pystr</span><span class="p">()</span><span class="si">}</span><span class="s2">.</span><span class="si">{</span><span class="n">fake</span><span class="o">.</span><span class="n">pystr</span><span class="p">()</span><span class="si">}</span><span class="s2">.svc&quot;</span><span class="p">,</span>
<a id="__codelineno-3-26" name="__codelineno-3-26" href="#__codelineno-3-26"></a>                <span class="sa">f</span><span class="s2">&quot;external/</span><span class="si">{</span><span class="n">fake</span><span class="o">.</span><span class="n">pystr</span><span class="p">()</span><span class="si">}</span><span class="s2">.</span><span class="si">{</span><span class="n">fake</span><span class="o">.</span><span class="n">pystr</span><span class="p">()</span><span class="si">}</span><span class="s2">.svc.cluster&quot;</span><span class="p">,</span>
<a id="__codelineno-3-27" name="__codelineno-3-27" href="#__codelineno-3-27"></a>                <span class="sa">f</span><span class="s2">&quot;external/</span><span class="si">{</span><span class="n">fake</span><span class="o">.</span><span class="n">pystr</span><span class="p">()</span><span class="si">}</span><span class="s2">.svc.cluster.local&quot;</span>
<a id="__codelineno-3-28" name="__codelineno-3-28" href="#__codelineno-3-28"></a>            <span class="p">]</span>
<a id="__codelineno-3-29" name="__codelineno-3-29" href="#__codelineno-3-29"></a>        <span class="p">}</span>
<a id="__codelineno-3-30" name="__codelineno-3-30" href="#__codelineno-3-30"></a>
<a id="__codelineno-3-31" name="__codelineno-3-31" href="#__codelineno-3-31"></a>
<a id="__codelineno-3-32" name="__codelineno-3-32" href="#__codelineno-3-32"></a><span class="k">def</span> <span class="nf">test_egress_schema</span><span class="p">(</span><span class="n">egress_data</span><span class="p">):</span>
<a id="__codelineno-3-33" name="__codelineno-3-33" href="#__codelineno-3-33"></a>    <span class="c1"># when</span>
<a id="__codelineno-3-34" name="__codelineno-3-34" href="#__codelineno-3-34"></a>    <span class="n">parsed</span> <span class="o">=</span> <span class="n">parse_obj_as</span><span class="p">(</span><span class="n">Egress</span><span class="p">,</span> <span class="n">egress_data</span><span class="p">)</span>
<a id="__codelineno-3-35" name="__codelineno-3-35" href="#__codelineno-3-35"></a>
<a id="__codelineno-3-36" name="__codelineno-3-36" href="#__codelineno-3-36"></a>    <span class="c1"># then</span>
<a id="__codelineno-3-37" name="__codelineno-3-37" href="#__codelineno-3-37"></a>    <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">parsed</span><span class="o">.</span><span class="n">hosts</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span>
<a id="__codelineno-3-38" name="__codelineno-3-38" href="#__codelineno-3-38"></a>    <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">parsed</span><span class="o">.</span><span class="n">hosts</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nb">str</span><span class="p">)</span>
<a id="__codelineno-3-39" name="__codelineno-3-39" href="#__codelineno-3-39"></a>
<a id="__codelineno-3-40" name="__codelineno-3-40" href="#__codelineno-3-40"></a><span class="nd">@egress_data</span><span class="p">(</span><span class="n">valid</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span> <span class="c1"># (5)</span>
<a id="__codelineno-3-41" name="__codelineno-3-41" href="#__codelineno-3-41"></a><span class="k">def</span> <span class="nf">test_egress_hosts_fqdn_raises_validation_error_on_invalid_entries</span><span class="p">(</span><span class="n">egress_data</span><span class="p">):</span>
<a id="__codelineno-3-42" name="__codelineno-3-42" href="#__codelineno-3-42"></a>    <span class="c1"># when</span>
<a id="__codelineno-3-43" name="__codelineno-3-43" href="#__codelineno-3-43"></a>    <span class="k">with</span> <span class="n">pytest</span><span class="o">.</span><span class="n">Raises</span><span class="p">(</span><span class="n">ValidationError</span><span class="p">,</span> <span class="n">match</span><span class="o">=</span><span class="s2">&quot;string does not match regex&quot;</span><span class="p">)</span>
<a id="__codelineno-3-44" name="__codelineno-3-44" href="#__codelineno-3-44"></a>    <span class="n">parsed</span> <span class="o">=</span> <span class="n">parse_obj_as</span><span class="p">(</span><span class="n">Egress</span><span class="p">,</span> <span class="n">egress_data</span><span class="p">)</span>
<a id="__codelineno-3-45" name="__codelineno-3-45" href="#__codelineno-3-45"></a>
<a id="__codelineno-3-46" name="__codelineno-3-46" href="#__codelineno-3-46"></a>    <span class="c1"># then</span>
<a id="__codelineno-3-47" name="__codelineno-3-47" href="#__codelineno-3-47"></a>    <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">parsed</span><span class="o">.</span><span class="n">hosts</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span>
<a id="__codelineno-3-48" name="__codelineno-3-48" href="#__codelineno-3-48"></a>    <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">parsed</span><span class="o">.</span><span class="n">hosts</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nb">str</span><span class="p">)</span>
</code></pre></div>
<ol>
<li>Update the <code>hosts</code> type to use <code>constr() with regex pattern matching</code></li>
<li>Update <code>egress_data()</code> fixture to output either valid or invalid data</li>
<li>valid output will pass Istio validation</li>
<li>Invalid output added</li>
<li>Test case added to test <code>ValidationError</code> is raised on invalid hosts</li>
</ol>
<p>However, the <code>ValidationError</code> message is miserable to parse:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-4-1" name="__codelineno-4-1" href="#__codelineno-4-1"></a>Expected Validation Error: &#39;string does not match regex &quot;^\*\/(?!:\/\/)(?=.{1,255}$)((.{1,63}\.){1,127}(?![0-9]*$)[a-z0-9-]+\.?)|external\/.+.svc.cluster.local&quot; (type=value_error.str.regex; pattern=^\*\/(?!:\/\/)(?=.{1,255}$)((.{1,63}\.){1,127}(?![0-9]*$)[a-z0-9-]+\.?)|external\/.+.svc.cluster.local
</code></pre></div>
<p>Furthermore, <code>flake8</code> validation fails when using Pydantic's <code>constr()</code> function, so it cannot be the way that the constraints can be validated.</p>
<h2 id="flake8-validation">Flake8 Validation</h2>
<p>Fixing <code>flake8</code> validation is relatively simple:</p>
<div class="highlight"><span class="filename">src/service_dependency_schema.py</span><pre><span></span><code><a id="__codelineno-5-1" name="__codelineno-5-1" href="#__codelineno-5-1"></a><span class="o">...</span>
<a id="__codelineno-5-2" name="__codelineno-5-2" href="#__codelineno-5-2"></a>
<a id="__codelineno-5-3" name="__codelineno-5-3" href="#__codelineno-5-3"></a><span class="k">class</span> <span class="nc">Egress</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">,</span> <span class="n">extra</span><span class="o">=</span><span class="s2">&quot;forbid&quot;</span><span class="p">):</span>
<a id="__codelineno-5-4" name="__codelineno-5-4" href="#__codelineno-5-4"></a>    <span class="n">regex_pattern</span> <span class="o">=</span> <span class="s2">&quot;^\*\/(?!:\/\/)(?=.{1,255}$)((.{1,63}\.){1,127}(?![0-9]*$)[a-z0-9-]+\.?)|external\/.+.svc.cluster.local&quot;</span>
<a id="__codelineno-5-5" name="__codelineno-5-5" href="#__codelineno-5-5"></a>    <span class="n">port</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Port</span><span class="p">]</span>
<a id="__codelineno-5-6" name="__codelineno-5-6" href="#__codelineno-5-6"></a>    <span class="n">hosts</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="n">regex</span><span class="o">=</span><span class="n">regex_pattern</span><span class="p">)</span> <span class="c1"># (1)</span>
<a id="__codelineno-5-7" name="__codelineno-5-7" href="#__codelineno-5-7"></a>
<a id="__codelineno-5-8" name="__codelineno-5-8" href="#__codelineno-5-8"></a>
<a id="__codelineno-5-9" name="__codelineno-5-9" href="#__codelineno-5-9"></a><span class="o">...</span>
</code></pre></div>
<ol>
<li>Instead of <code>constr()</code>, using <code>Field()</code> allows <code>flake8</code> validations to pass successfully.</li>
</ol>
<p>The next step is to tackle the <code>ValidationError</code> message.</p>
<h2 id="breaking-up-the-regex">Breaking Up the Regex</h2>
<p>The regex pattern being used does the following:</p>
<ol>
<li><code>^\*\/</code> - If the FQDN is <code>*/</code> prefixed:<ol>
<li><code>(?!:\/\/)</code> - Disallow URL schema prefix</li>
<li><code>(?=.{1,255}$)</code> - FQDN character constraints between 1 and 255</li>
<li><code>((.{1,63}\.)</code> - Domain label character constraints between 1 and 63</li>
<li><code>{1,127}</code> - FQDN Domain label constraints between 1 and 127</li>
<li><code>(?![0-9]*$)[a-z0-9-]+</code> - TLD cannot consist of numbers</li>
<li><code>\.?</code> - no more than one optional trailing dot</li>
</ol>
</li>
<li><code>external\/.+.svc.cluster.local</code> - If the FQDN is <code>external/</code> prefixed, ensure the name is fully qualified with the local cluster dns suffix</li>
</ol>
<p>In its current form, the regex pattern raises an error with a <em>single</em> error message that says the field value was not matched by the regex pattern.  If the regex was broken up and used to perform individual validations, reasons for validation could be far more actionable:</p>
<div class="highlight"><span class="filename">src/service_dependency_schema.py</span><pre><span></span><code><a id="__codelineno-6-1" name="__codelineno-6-1" href="#__codelineno-6-1"></a><span class="o">...</span>
<a id="__codelineno-6-2" name="__codelineno-6-2" href="#__codelineno-6-2"></a><span class="k">class</span> <span class="nc">Egress</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">,</span> <span class="n">extra</span><span class="o">=</span><span class="s2">&quot;forbid&quot;</span><span class="p">):</span>
<a id="__codelineno-6-3" name="__codelineno-6-3" href="#__codelineno-6-3"></a>    <span class="n">port</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Port</span><span class="p">]</span>
<a id="__codelineno-6-4" name="__codelineno-6-4" href="#__codelineno-6-4"></a>    <span class="n">hosts</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="c1"># (1)</span>
<a id="__codelineno-6-5" name="__codelineno-6-5" href="#__codelineno-6-5"></a>
<a id="__codelineno-6-6" name="__codelineno-6-6" href="#__codelineno-6-6"></a>    <span class="nd">@validator</span><span class="p">(</span><span class="s2">&quot;hosts&quot;</span><span class="p">)</span>
<a id="__codelineno-6-7" name="__codelineno-6-7" href="#__codelineno-6-7"></a>    <span class="k">def</span> <span class="nf">hosts_fqdn_must_be_valid</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">v</span><span class="p">):</span> <span class="c1"># (2)</span>
<a id="__codelineno-6-8" name="__codelineno-6-8" href="#__codelineno-6-8"></a>
<a id="__codelineno-6-9" name="__codelineno-6-9" href="#__codelineno-6-9"></a>        <span class="k">for</span> <span class="n">host</span> <span class="ow">in</span> <span class="n">v</span><span class="p">:</span> <span class="c1"># (3)</span>
<a id="__codelineno-6-10" name="__codelineno-6-10" href="#__codelineno-6-10"></a>            <span class="n">no_slash_prefix_regex_pattern</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s2">&quot;^(\*|external)\/.+$&quot;</span><span class="p">)</span>
<a id="__codelineno-6-11" name="__codelineno-6-11" href="#__codelineno-6-11"></a>            <span class="k">if</span> <span class="ow">not</span> <span class="n">no_slash_prefix_regex_pattern</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">host</span><span class="p">):</span>
<a id="__codelineno-6-12" name="__codelineno-6-12" href="#__codelineno-6-12"></a>                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Invalid FQDN.  Must include &#39;*/&#39; or &#39;external/&#39; prefix.&quot;</span><span class="p">)</span>
<a id="__codelineno-6-13" name="__codelineno-6-13" href="#__codelineno-6-13"></a>
<a id="__codelineno-6-14" name="__codelineno-6-14" href="#__codelineno-6-14"></a>            <span class="n">no_http_schema_regex_pattern</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s2">&quot;^(\*|external)\/((?!.+:\/\/).+)$&quot;</span><span class="p">)</span>
<a id="__codelineno-6-15" name="__codelineno-6-15" href="#__codelineno-6-15"></a>            <span class="k">if</span> <span class="ow">not</span> <span class="n">no_http_schema_regex_pattern</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">host</span><span class="p">):</span>
<a id="__codelineno-6-16" name="__codelineno-6-16" href="#__codelineno-6-16"></a>                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
<a id="__codelineno-6-17" name="__codelineno-6-17" href="#__codelineno-6-17"></a>                    <span class="sa">f</span><span class="s2">&quot;Host FQDN cannot begin with &#39;://&#39; schema.&quot;</span>
<a id="__codelineno-6-18" name="__codelineno-6-18" href="#__codelineno-6-18"></a>                <span class="p">)</span>
<a id="__codelineno-6-19" name="__codelineno-6-19" href="#__codelineno-6-19"></a>
<a id="__codelineno-6-20" name="__codelineno-6-20" href="#__codelineno-6-20"></a>            <span class="n">host_min_max_domain_levels_regex_pattern</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span>
<a id="__codelineno-6-21" name="__codelineno-6-21" href="#__codelineno-6-21"></a>                <span class="s2">&quot;^(\*|external)\/([A-Za-z0-9-]+\.){1,127}[A-Za-z0-9-]+\.?$&quot;</span>
<a id="__codelineno-6-22" name="__codelineno-6-22" href="#__codelineno-6-22"></a>            <span class="p">)</span>
<a id="__codelineno-6-23" name="__codelineno-6-23" href="#__codelineno-6-23"></a>            <span class="k">if</span> <span class="ow">not</span> <span class="n">host_min_max_domain_levels_regex_pattern</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">host</span><span class="p">):</span>
<a id="__codelineno-6-24" name="__codelineno-6-24" href="#__codelineno-6-24"></a>                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
<a id="__codelineno-6-25" name="__codelineno-6-25" href="#__codelineno-6-25"></a>                    <span class="sa">f</span><span class="s2">&quot;Valid number of domain labels for host FQDN between 1 and 127.&quot;</span>
<a id="__codelineno-6-26" name="__codelineno-6-26" href="#__codelineno-6-26"></a>                <span class="p">)</span>
<a id="__codelineno-6-27" name="__codelineno-6-27" href="#__codelineno-6-27"></a>
<a id="__codelineno-6-28" name="__codelineno-6-28" href="#__codelineno-6-28"></a>            <span class="n">host_min_max_characters_regex_pattern</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s2">&quot;^(\*|external)\/((?=.{1,255}$).+$)&quot;</span><span class="p">)</span>
<a id="__codelineno-6-29" name="__codelineno-6-29" href="#__codelineno-6-29"></a>            <span class="k">if</span> <span class="ow">not</span> <span class="n">host_min_max_characters_regex_pattern</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">host</span><span class="p">):</span>
<a id="__codelineno-6-30" name="__codelineno-6-30" href="#__codelineno-6-30"></a>                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
<a id="__codelineno-6-31" name="__codelineno-6-31" href="#__codelineno-6-31"></a>                    <span class="sa">f</span><span class="s2">&quot;Valid character length for host FQDN between 1 and 255.&quot;</span>
<a id="__codelineno-6-32" name="__codelineno-6-32" href="#__codelineno-6-32"></a>                <span class="p">)</span>
<a id="__codelineno-6-33" name="__codelineno-6-33" href="#__codelineno-6-33"></a>
<a id="__codelineno-6-34" name="__codelineno-6-34" href="#__codelineno-6-34"></a>            <span class="n">host_min_max_domain_label_regex_pattern</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s2">&quot;^(\*|external)\/((.{1,63}\.).+$)&quot;</span><span class="p">)</span>
<a id="__codelineno-6-35" name="__codelineno-6-35" href="#__codelineno-6-35"></a>            <span class="k">if</span> <span class="ow">not</span> <span class="n">host_min_max_domain_label_regex_pattern</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">host</span><span class="p">):</span>
<a id="__codelineno-6-36" name="__codelineno-6-36" href="#__codelineno-6-36"></a>                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
<a id="__codelineno-6-37" name="__codelineno-6-37" href="#__codelineno-6-37"></a>                    <span class="sa">f</span><span class="s2">&quot;Valid character length for each domain label between 1-63.&quot;</span>
<a id="__codelineno-6-38" name="__codelineno-6-38" href="#__codelineno-6-38"></a>                <span class="p">)</span>
<a id="__codelineno-6-39" name="__codelineno-6-39" href="#__codelineno-6-39"></a>
<a id="__codelineno-6-40" name="__codelineno-6-40" href="#__codelineno-6-40"></a>            <span class="n">tld_does_not_begin_with_or_contain_only_numerics_regex_pattern</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span>
<a id="__codelineno-6-41" name="__codelineno-6-41" href="#__codelineno-6-41"></a>                <span class="s2">&quot;^(\*|external)\/(.+\.(?![0-9])[A-Za-z0-9-]+)\.?$&quot;</span>
<a id="__codelineno-6-42" name="__codelineno-6-42" href="#__codelineno-6-42"></a>            <span class="p">)</span>
<a id="__codelineno-6-43" name="__codelineno-6-43" href="#__codelineno-6-43"></a>            <span class="k">if</span> <span class="ow">not</span> <span class="n">tld_does_not_begin_with_or_contain_only_numerics_regex_pattern</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">host</span><span class="p">):</span>
<a id="__codelineno-6-44" name="__codelineno-6-44" href="#__codelineno-6-44"></a>                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
<a id="__codelineno-6-45" name="__codelineno-6-45" href="#__codelineno-6-45"></a>                    <span class="sa">f</span><span class="s2">&quot;TLD must not begin with a numeric, or contain only numerics.&quot;</span>
<a id="__codelineno-6-46" name="__codelineno-6-46" href="#__codelineno-6-46"></a>                <span class="p">)</span>
<a id="__codelineno-6-47" name="__codelineno-6-47" href="#__codelineno-6-47"></a>
<a id="__codelineno-6-48" name="__codelineno-6-48" href="#__codelineno-6-48"></a>            <span class="n">external_slashed_fqdn_regex_pattern</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s2">&quot;^external\/.+$&quot;</span><span class="p">)</span>
<a id="__codelineno-6-49" name="__codelineno-6-49" href="#__codelineno-6-49"></a>            <span class="k">if</span> <span class="n">external_slashed_fqdn_regex_pattern</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">host</span><span class="p">):</span>
<a id="__codelineno-6-50" name="__codelineno-6-50" href="#__codelineno-6-50"></a>                <span class="n">external_slashed_fqdn_must_contain_service_and_namespace_domain_labels_regex_pattern</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span>
<a id="__codelineno-6-51" name="__codelineno-6-51" href="#__codelineno-6-51"></a>                    <span class="s2">&quot;^external\/[A-Za-z0-9-]+\.(?=svc\.cluster\.local$)&quot;</span>
<a id="__codelineno-6-52" name="__codelineno-6-52" href="#__codelineno-6-52"></a>                <span class="p">)</span>
<a id="__codelineno-6-53" name="__codelineno-6-53" href="#__codelineno-6-53"></a>                <span class="k">if</span> <span class="n">external_slashed_fqdn_must_contain_service_and_namespace_domain_labels_regex_pattern</span><span class="o">.</span><span class="n">match</span><span class="p">(</span>
<a id="__codelineno-6-54" name="__codelineno-6-54" href="#__codelineno-6-54"></a>                    <span class="n">host</span>
<a id="__codelineno-6-55" name="__codelineno-6-55" href="#__codelineno-6-55"></a>                <span class="p">):</span>
<a id="__codelineno-6-56" name="__codelineno-6-56" href="#__codelineno-6-56"></a>                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
<a id="__codelineno-6-57" name="__codelineno-6-57" href="#__codelineno-6-57"></a>                        <span class="sa">f</span><span class="s2">&quot;&#39;external/&#39; host FQDNs must include service and namespace domain labels.&quot;</span>
<a id="__codelineno-6-58" name="__codelineno-6-58" href="#__codelineno-6-58"></a>                    <span class="p">)</span>
<a id="__codelineno-6-59" name="__codelineno-6-59" href="#__codelineno-6-59"></a>
<a id="__codelineno-6-60" name="__codelineno-6-60" href="#__codelineno-6-60"></a>                <span class="n">external_slahed_fqdn_must_have_cluster_dns_suffix_regex_pattern</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span>
<a id="__codelineno-6-61" name="__codelineno-6-61" href="#__codelineno-6-61"></a>                    <span class="s2">&quot;^external\/.+\.svc\.cluster\.local$&quot;</span>
<a id="__codelineno-6-62" name="__codelineno-6-62" href="#__codelineno-6-62"></a>                <span class="p">)</span>
<a id="__codelineno-6-63" name="__codelineno-6-63" href="#__codelineno-6-63"></a>                <span class="k">if</span> <span class="ow">not</span> <span class="n">external_slahed_fqdn_must_have_cluster_dns_suffix_regex_pattern</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">host</span><span class="p">):</span>
<a id="__codelineno-6-64" name="__codelineno-6-64" href="#__codelineno-6-64"></a>                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
<a id="__codelineno-6-65" name="__codelineno-6-65" href="#__codelineno-6-65"></a>                        <span class="sa">f</span><span class="s2">&quot;&#39;external/&#39; host FQDNs must contain the cluster DNS suffix.&quot;</span>
<a id="__codelineno-6-66" name="__codelineno-6-66" href="#__codelineno-6-66"></a>                    <span class="p">)</span>
<a id="__codelineno-6-67" name="__codelineno-6-67" href="#__codelineno-6-67"></a>
<a id="__codelineno-6-68" name="__codelineno-6-68" href="#__codelineno-6-68"></a>        <span class="k">return</span> <span class="n">v</span>
<a id="__codelineno-6-69" name="__codelineno-6-69" href="#__codelineno-6-69"></a><span class="o">...</span>
</code></pre></div>
<ol>
<li>Since the <code>Field</code> class constraint capabilities do not meet the solution requirements, it is removed and normal type validation is used instead.</li>
<li>The <code>hosts_fqdn_must_be_valid</code> uses the <code>validator</code> decorator, which pydantic will run each time it perform schema validation.</li>
<li>The <code>hosts_fqdn_must_be_valid</code> validator method loops through each <code>hosts</code> value, and performs regex matches through nested if statements, which is never great, and should be refactored as soon as pydantic's validation capabilities are better understood.</li>
</ol>
<p>Additionally, the unit tests are dramatically expanded:</p>
<div class="highlight"><span class="filename">tests/unit/test_service_dependency_schema.py</span><pre><span></span><code><a id="__codelineno-7-1" name="__codelineno-7-1" href="#__codelineno-7-1"></a><span class="kn">from</span> <span class="nn">pydantic</span> <span class="kn">import</span> <span class="n">ValidationError</span><span class="p">,</span> <span class="n">parse_obj_as</span>
<a id="__codelineno-7-2" name="__codelineno-7-2" href="#__codelineno-7-2"></a><span class="kn">from</span> <span class="nn">src.service_dependency_schema</span> <span class="kn">import</span> <span class="n">Egress</span>
<a id="__codelineno-7-3" name="__codelineno-7-3" href="#__codelineno-7-3"></a><span class="kn">from</span> <span class="nn">Faker</span> <span class="kn">import</span> <span class="n">Faker</span>
<a id="__codelineno-7-4" name="__codelineno-7-4" href="#__codelineno-7-4"></a><span class="kn">from</span> <span class="nn">faker.providers</span> <span class="kn">import</span> <span class="n">python</span><span class="p">,</span> <span class="n">internet</span>
<a id="__codelineno-7-5" name="__codelineno-7-5" href="#__codelineno-7-5"></a><span class="kn">import</span> <span class="nn">pytest</span>
<a id="__codelineno-7-6" name="__codelineno-7-6" href="#__codelineno-7-6"></a>
<a id="__codelineno-7-7" name="__codelineno-7-7" href="#__codelineno-7-7"></a><span class="n">fake</span> <span class="o">=</span> <span class="n">Faker</span><span class="p">()</span>
<a id="__codelineno-7-8" name="__codelineno-7-8" href="#__codelineno-7-8"></a><span class="n">fake</span><span class="o">.</span><span class="n">add_provider</span><span class="p">(</span><span class="n">python</span><span class="p">)</span>
<a id="__codelineno-7-9" name="__codelineno-7-9" href="#__codelineno-7-9"></a><span class="n">fake</span><span class="o">.</span><span class="n">add_provider</span><span class="p">(</span><span class="n">internet</span><span class="p">)</span>
<a id="__codelineno-7-10" name="__codelineno-7-10" href="#__codelineno-7-10"></a>
<a id="__codelineno-7-11" name="__codelineno-7-11" href="#__codelineno-7-11"></a>
<a id="__codelineno-7-12" name="__codelineno-7-12" href="#__codelineno-7-12"></a><span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
<a id="__codelineno-7-13" name="__codelineno-7-13" href="#__codelineno-7-13"></a><span class="k">def</span> <span class="nf">egress_data</span><span class="p">(</span><span class="n">valid</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<a id="__codelineno-7-14" name="__codelineno-7-14" href="#__codelineno-7-14"></a>    <span class="k">if</span> <span class="n">valid</span><span class="p">:</span>
<a id="__codelineno-7-15" name="__codelineno-7-15" href="#__codelineno-7-15"></a>        <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;hosts&quot;</span><span class="p">:</span> <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;external/</span><span class="si">{</span><span class="n">fake</span><span class="o">.</span><span class="n">pystr</span><span class="p">()</span><span class="si">}</span><span class="s2">.</span><span class="si">{</span><span class="n">fake</span><span class="o">.</span><span class="n">pystr</span><span class="p">()</span><span class="si">}</span><span class="s2">.svc.cluster.local&quot;</span><span class="p">]}</span>
<a id="__codelineno-7-16" name="__codelineno-7-16" href="#__codelineno-7-16"></a>    <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-7-17" name="__codelineno-7-17" href="#__codelineno-7-17"></a>        <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;hosts&quot;</span><span class="p">:</span> <span class="p">[</span>
<a id="__codelineno-7-18" name="__codelineno-7-18" href="#__codelineno-7-18"></a>                <span class="sa">f</span><span class="s2">&quot;external/</span><span class="si">{</span><span class="n">fake</span><span class="o">.</span><span class="n">pystr</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
<a id="__codelineno-7-19" name="__codelineno-7-19" href="#__codelineno-7-19"></a>                <span class="sa">f</span><span class="s2">&quot;external/</span><span class="si">{</span><span class="n">fake</span><span class="o">.</span><span class="n">pystr</span><span class="p">()</span><span class="si">}</span><span class="s2">.</span><span class="si">{</span><span class="n">fake</span><span class="o">.</span><span class="n">pystr</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
<a id="__codelineno-7-20" name="__codelineno-7-20" href="#__codelineno-7-20"></a>                <span class="sa">f</span><span class="s2">&quot;external/</span><span class="si">{</span><span class="n">fake</span><span class="o">.</span><span class="n">pystr</span><span class="p">()</span><span class="si">}</span><span class="s2">.</span><span class="si">{</span><span class="n">fake</span><span class="o">.</span><span class="n">pystr</span><span class="p">()</span><span class="si">}</span><span class="s2">.svc&quot;</span><span class="p">,</span>
<a id="__codelineno-7-21" name="__codelineno-7-21" href="#__codelineno-7-21"></a>                <span class="sa">f</span><span class="s2">&quot;external/</span><span class="si">{</span><span class="n">fake</span><span class="o">.</span><span class="n">pystr</span><span class="p">()</span><span class="si">}</span><span class="s2">.</span><span class="si">{</span><span class="n">fake</span><span class="o">.</span><span class="n">pystr</span><span class="p">()</span><span class="si">}</span><span class="s2">.svc.cluster&quot;</span><span class="p">,</span>
<a id="__codelineno-7-22" name="__codelineno-7-22" href="#__codelineno-7-22"></a>                <span class="sa">f</span><span class="s2">&quot;external/</span><span class="si">{</span><span class="n">fake</span><span class="o">.</span><span class="n">pystr</span><span class="p">()</span><span class="si">}</span><span class="s2">.svc.cluster.local&quot;</span>
<a id="__codelineno-7-23" name="__codelineno-7-23" href="#__codelineno-7-23"></a>            <span class="p">]</span>
<a id="__codelineno-7-24" name="__codelineno-7-24" href="#__codelineno-7-24"></a>        <span class="p">}</span>
<a id="__codelineno-7-25" name="__codelineno-7-25" href="#__codelineno-7-25"></a>
<a id="__codelineno-7-26" name="__codelineno-7-26" href="#__codelineno-7-26"></a>
<a id="__codelineno-7-27" name="__codelineno-7-27" href="#__codelineno-7-27"></a><span class="k">def</span> <span class="nf">test_egress_schema</span><span class="p">(</span><span class="n">egress_data</span><span class="p">):</span>
<a id="__codelineno-7-28" name="__codelineno-7-28" href="#__codelineno-7-28"></a>    <span class="c1"># when</span>
<a id="__codelineno-7-29" name="__codelineno-7-29" href="#__codelineno-7-29"></a>    <span class="n">parsed</span> <span class="o">=</span> <span class="n">parse_obj_as</span><span class="p">(</span><span class="n">Egress</span><span class="p">,</span> <span class="n">egress_data</span><span class="p">)</span>
<a id="__codelineno-7-30" name="__codelineno-7-30" href="#__codelineno-7-30"></a>
<a id="__codelineno-7-31" name="__codelineno-7-31" href="#__codelineno-7-31"></a>    <span class="c1"># then</span>
<a id="__codelineno-7-32" name="__codelineno-7-32" href="#__codelineno-7-32"></a>    <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">parsed</span><span class="o">.</span><span class="n">hosts</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span>
<a id="__codelineno-7-33" name="__codelineno-7-33" href="#__codelineno-7-33"></a>    <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">parsed</span><span class="o">.</span><span class="n">hosts</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nb">str</span><span class="p">)</span>
<a id="__codelineno-7-34" name="__codelineno-7-34" href="#__codelineno-7-34"></a>
<a id="__codelineno-7-35" name="__codelineno-7-35" href="#__codelineno-7-35"></a><span class="nd">@pytest</span><span class="o">.</span><span class="n">mark</span><span class="o">.</span><span class="n">parametrize</span><span class="p">(</span>
<a id="__codelineno-7-36" name="__codelineno-7-36" href="#__codelineno-7-36"></a>    <span class="s2">&quot;fqdn_schema_data&quot;</span><span class="p">,</span>
<a id="__codelineno-7-37" name="__codelineno-7-37" href="#__codelineno-7-37"></a>    <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">generate_string</span><span class="p">()</span><span class="si">}</span><span class="s2">.</span><span class="si">{</span><span class="n">generate_string</span><span class="p">()</span><span class="si">}</span><span class="s2">.svc.cluster.local&quot;</span><span class="p">,</span> <span class="n">fake</span><span class="o">.</span><span class="n">domain_name</span><span class="p">()],</span>
<a id="__codelineno-7-38" name="__codelineno-7-38" href="#__codelineno-7-38"></a><span class="p">)</span>
<a id="__codelineno-7-39" name="__codelineno-7-39" href="#__codelineno-7-39"></a><span class="k">def</span> <span class="nf">test_egress_disallow_hosts_without_slash_prefix</span><span class="p">(</span><span class="n">fqdn_schema_data</span><span class="p">):</span>
<a id="__codelineno-7-40" name="__codelineno-7-40" href="#__codelineno-7-40"></a>    <span class="c1"># when</span>
<a id="__codelineno-7-41" name="__codelineno-7-41" href="#__codelineno-7-41"></a>    <span class="n">egress_data</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;hosts&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">fqdn_schema_data</span><span class="p">]}</span>
<a id="__codelineno-7-42" name="__codelineno-7-42" href="#__codelineno-7-42"></a>
<a id="__codelineno-7-43" name="__codelineno-7-43" href="#__codelineno-7-43"></a>    <span class="c1"># then</span>
<a id="__codelineno-7-44" name="__codelineno-7-44" href="#__codelineno-7-44"></a>    <span class="k">with</span> <span class="n">pytest</span><span class="o">.</span><span class="n">raises</span><span class="p">(</span>
<a id="__codelineno-7-45" name="__codelineno-7-45" href="#__codelineno-7-45"></a>        <span class="n">ValidationError</span><span class="p">,</span> <span class="n">match</span><span class="o">=</span><span class="sa">r</span><span class="s2">&quot;Invalid FQDN.  Must include &#39;\*\/&#39; or &#39;external\/&#39; prefix.&quot;</span>
<a id="__codelineno-7-46" name="__codelineno-7-46" href="#__codelineno-7-46"></a>    <span class="p">):</span>
<a id="__codelineno-7-47" name="__codelineno-7-47" href="#__codelineno-7-47"></a>        <span class="n">parse_obj_as</span><span class="p">(</span><span class="n">Egress</span><span class="p">,</span> <span class="n">egress_data</span><span class="p">)</span>
<a id="__codelineno-7-48" name="__codelineno-7-48" href="#__codelineno-7-48"></a>
<a id="__codelineno-7-49" name="__codelineno-7-49" href="#__codelineno-7-49"></a>
<a id="__codelineno-7-50" name="__codelineno-7-50" href="#__codelineno-7-50"></a><span class="nd">@pytest</span><span class="o">.</span><span class="n">mark</span><span class="o">.</span><span class="n">parametrize</span><span class="p">(</span>
<a id="__codelineno-7-51" name="__codelineno-7-51" href="#__codelineno-7-51"></a>    <span class="s2">&quot;fqdn_schema_data&quot;</span><span class="p">,</span>
<a id="__codelineno-7-52" name="__codelineno-7-52" href="#__codelineno-7-52"></a>    <span class="p">[</span>
<a id="__codelineno-7-53" name="__codelineno-7-53" href="#__codelineno-7-53"></a>        <span class="sa">f</span><span class="s2">&quot;*/https://</span><span class="si">{</span><span class="n">fake</span><span class="o">.</span><span class="n">domain_name</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
<a id="__codelineno-7-54" name="__codelineno-7-54" href="#__codelineno-7-54"></a>        <span class="sa">f</span><span class="s2">&quot;*/http://</span><span class="si">{</span><span class="n">fake</span><span class="o">.</span><span class="n">domain_name</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
<a id="__codelineno-7-55" name="__codelineno-7-55" href="#__codelineno-7-55"></a>        <span class="sa">f</span><span class="s2">&quot;*/tcp://</span><span class="si">{</span><span class="n">fake</span><span class="o">.</span><span class="n">domain_name</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
<a id="__codelineno-7-56" name="__codelineno-7-56" href="#__codelineno-7-56"></a>        <span class="sa">f</span><span class="s2">&quot;*/</span><span class="si">{</span><span class="n">fake</span><span class="o">.</span><span class="n">pystr</span><span class="p">()</span><span class="si">}</span><span class="s2">://</span><span class="si">{</span><span class="n">fake</span><span class="o">.</span><span class="n">domain_name</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
<a id="__codelineno-7-57" name="__codelineno-7-57" href="#__codelineno-7-57"></a>        <span class="sa">f</span><span class="s2">&quot;external/http://</span><span class="si">{</span><span class="n">fake</span><span class="o">.</span><span class="n">pystr</span><span class="p">()</span><span class="si">}</span><span class="s2">.</span><span class="si">{</span><span class="n">fake</span><span class="o">.</span><span class="n">pystr</span><span class="p">()</span><span class="si">}</span><span class="s2">.svc.cluster.local&quot;</span><span class="p">,</span>
<a id="__codelineno-7-58" name="__codelineno-7-58" href="#__codelineno-7-58"></a>        <span class="sa">f</span><span class="s2">&quot;external/https://</span><span class="si">{</span><span class="n">fake</span><span class="o">.</span><span class="n">pystr</span><span class="p">()</span><span class="si">}</span><span class="s2">.</span><span class="si">{</span><span class="n">fake</span><span class="o">.</span><span class="n">pystr</span><span class="p">()</span><span class="si">}</span><span class="s2">.svc.cluster.local&quot;</span><span class="p">,</span>
<a id="__codelineno-7-59" name="__codelineno-7-59" href="#__codelineno-7-59"></a>        <span class="sa">f</span><span class="s2">&quot;external/tcp://</span><span class="si">{</span><span class="n">fake</span><span class="o">.</span><span class="n">pystr</span><span class="p">()</span><span class="si">}</span><span class="s2">.</span><span class="si">{</span><span class="n">fake</span><span class="o">.</span><span class="n">pystr</span><span class="p">()</span><span class="si">}</span><span class="s2">.svc.cluster.local&quot;</span><span class="p">,</span>
<a id="__codelineno-7-60" name="__codelineno-7-60" href="#__codelineno-7-60"></a>        <span class="sa">f</span><span class="s2">&quot;external/</span><span class="si">{</span><span class="n">fake</span><span class="o">.</span><span class="n">pystr</span><span class="p">()</span><span class="si">}</span><span class="s2">://</span><span class="si">{</span><span class="n">fake</span><span class="o">.</span><span class="n">pystr</span><span class="p">()</span><span class="si">}</span><span class="s2">.</span><span class="si">{</span><span class="n">fake</span><span class="o">.</span><span class="n">pystr</span><span class="p">()</span><span class="si">}</span><span class="s2">.svc.cluster.local&quot;</span><span class="p">,</span>
<a id="__codelineno-7-61" name="__codelineno-7-61" href="#__codelineno-7-61"></a>    <span class="p">],</span>
<a id="__codelineno-7-62" name="__codelineno-7-62" href="#__codelineno-7-62"></a><span class="p">)</span>
<a id="__codelineno-7-63" name="__codelineno-7-63" href="#__codelineno-7-63"></a><span class="k">def</span> <span class="nf">test_egress_disallow_hosts_with_url_schema</span><span class="p">(</span><span class="n">fqdn_schema_data</span><span class="p">):</span>
<a id="__codelineno-7-64" name="__codelineno-7-64" href="#__codelineno-7-64"></a>    <span class="c1"># when</span>
<a id="__codelineno-7-65" name="__codelineno-7-65" href="#__codelineno-7-65"></a>    <span class="n">egress_data</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;hosts&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">fqdn_schema_data</span><span class="p">]}</span>
<a id="__codelineno-7-66" name="__codelineno-7-66" href="#__codelineno-7-66"></a>
<a id="__codelineno-7-67" name="__codelineno-7-67" href="#__codelineno-7-67"></a>    <span class="c1"># then</span>
<a id="__codelineno-7-68" name="__codelineno-7-68" href="#__codelineno-7-68"></a>    <span class="k">with</span> <span class="n">pytest</span><span class="o">.</span><span class="n">raises</span><span class="p">(</span><span class="n">ValidationError</span><span class="p">,</span> <span class="n">match</span><span class="o">=</span><span class="s2">&quot;Host FQDN cannot begin with &#39;://&#39; schema.&quot;</span><span class="p">):</span>
<a id="__codelineno-7-69" name="__codelineno-7-69" href="#__codelineno-7-69"></a>        <span class="n">parse_obj_as</span><span class="p">(</span><span class="n">Egress</span><span class="p">,</span> <span class="n">egress_data</span><span class="p">)</span>
<a id="__codelineno-7-70" name="__codelineno-7-70" href="#__codelineno-7-70"></a>
<a id="__codelineno-7-71" name="__codelineno-7-71" href="#__codelineno-7-71"></a>
<a id="__codelineno-7-72" name="__codelineno-7-72" href="#__codelineno-7-72"></a><span class="nd">@pytest</span><span class="o">.</span><span class="n">mark</span><span class="o">.</span><span class="n">parametrize</span><span class="p">(</span>
<a id="__codelineno-7-73" name="__codelineno-7-73" href="#__codelineno-7-73"></a>    <span class="s2">&quot;fqdn_schema_data&quot;</span><span class="p">,</span>
<a id="__codelineno-7-74" name="__codelineno-7-74" href="#__codelineno-7-74"></a>    <span class="p">[</span>
<a id="__codelineno-7-75" name="__codelineno-7-75" href="#__codelineno-7-75"></a>        <span class="sa">f</span><span class="s2">&quot;external/</span><span class="si">{</span><span class="n">fake</span><span class="o">.</span><span class="n">pystr</span><span class="p">(</span><span class="n">min_chars</span><span class="o">=</span><span class="mi">128</span><span class="p">,</span><span class="w"> </span><span class="n">max_chars</span><span class="o">=</span><span class="mi">128</span><span class="p">)</span><span class="si">}</span><span class="s2">.</span><span class="si">{</span><span class="n">fake</span><span class="o">.</span><span class="n">pystr</span><span class="p">(</span><span class="n">min_chars</span><span class="o">=</span><span class="mi">128</span><span class="p">,</span><span class="w"> </span><span class="n">max_chars</span><span class="o">=</span><span class="mi">128</span><span class="p">)</span><span class="si">}</span><span class="s2">.svc.cluster.local&quot;</span><span class="p">,</span>
<a id="__codelineno-7-76" name="__codelineno-7-76" href="#__codelineno-7-76"></a>        <span class="sa">f</span><span class="s2">&quot;*/</span><span class="si">{</span><span class="n">fake</span><span class="o">.</span><span class="n">pystr</span><span class="p">(</span><span class="n">min_chars</span><span class="o">=</span><span class="mi">128</span><span class="p">,</span><span class="w"> </span><span class="n">max_chars</span><span class="o">=</span><span class="mi">128</span><span class="p">)</span><span class="si">}</span><span class="s2">.</span><span class="si">{</span><span class="n">fake</span><span class="o">.</span><span class="n">pystr</span><span class="p">(</span><span class="n">min_chars</span><span class="o">=</span><span class="mi">128</span><span class="p">,</span><span class="w"> </span><span class="n">max_chars</span><span class="o">=</span><span class="mi">128</span><span class="p">)</span><span class="si">}</span><span class="s2">.org&quot;</span><span class="p">,</span>
<a id="__codelineno-7-77" name="__codelineno-7-77" href="#__codelineno-7-77"></a>    <span class="p">],</span>
<a id="__codelineno-7-78" name="__codelineno-7-78" href="#__codelineno-7-78"></a><span class="p">)</span>
<a id="__codelineno-7-79" name="__codelineno-7-79" href="#__codelineno-7-79"></a><span class="k">def</span> <span class="nf">test_egress_disallow_hosts_above_max_characters</span><span class="p">(</span><span class="n">fqdn_schema_data</span><span class="p">):</span>
<a id="__codelineno-7-80" name="__codelineno-7-80" href="#__codelineno-7-80"></a>    <span class="c1"># when</span>
<a id="__codelineno-7-81" name="__codelineno-7-81" href="#__codelineno-7-81"></a>    <span class="n">egress_data</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;hosts&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">fqdn_schema_data</span><span class="p">]}</span>
<a id="__codelineno-7-82" name="__codelineno-7-82" href="#__codelineno-7-82"></a>
<a id="__codelineno-7-83" name="__codelineno-7-83" href="#__codelineno-7-83"></a>    <span class="c1"># then</span>
<a id="__codelineno-7-84" name="__codelineno-7-84" href="#__codelineno-7-84"></a>    <span class="k">with</span> <span class="n">pytest</span><span class="o">.</span><span class="n">raises</span><span class="p">(</span>
<a id="__codelineno-7-85" name="__codelineno-7-85" href="#__codelineno-7-85"></a>        <span class="n">ValidationError</span><span class="p">,</span> <span class="n">match</span><span class="o">=</span><span class="s2">&quot;Valid character length for host FQDN between 1 and 255.&quot;</span>
<a id="__codelineno-7-86" name="__codelineno-7-86" href="#__codelineno-7-86"></a>    <span class="p">):</span>
<a id="__codelineno-7-87" name="__codelineno-7-87" href="#__codelineno-7-87"></a>        <span class="n">parse_obj_as</span><span class="p">(</span><span class="n">Egress</span><span class="p">,</span> <span class="n">egress_data</span><span class="p">)</span>
<a id="__codelineno-7-88" name="__codelineno-7-88" href="#__codelineno-7-88"></a>
<a id="__codelineno-7-89" name="__codelineno-7-89" href="#__codelineno-7-89"></a>
<a id="__codelineno-7-90" name="__codelineno-7-90" href="#__codelineno-7-90"></a><span class="nd">@pytest</span><span class="o">.</span><span class="n">mark</span><span class="o">.</span><span class="n">parametrize</span><span class="p">(</span>
<a id="__codelineno-7-91" name="__codelineno-7-91" href="#__codelineno-7-91"></a>    <span class="s2">&quot;fqdn_schema_data&quot;</span><span class="p">,</span>
<a id="__codelineno-7-92" name="__codelineno-7-92" href="#__codelineno-7-92"></a>    <span class="p">[</span>
<a id="__codelineno-7-93" name="__codelineno-7-93" href="#__codelineno-7-93"></a>        <span class="sa">f</span><span class="s2">&quot;external/</span><span class="si">{</span><span class="n">fake</span><span class="o">.</span><span class="n">pystr</span><span class="p">(</span><span class="n">min_chars</span><span class="o">=</span><span class="mi">65</span><span class="p">,</span><span class="w"> </span><span class="n">max_chars</span><span class="o">=</span><span class="mi">65</span><span class="p">)</span><span class="si">}</span><span class="s2">.</span><span class="si">{</span><span class="n">fake</span><span class="o">.</span><span class="n">pystr</span><span class="p">()</span><span class="si">}</span><span class="s2">.svc.cluster.local&quot;</span><span class="p">,</span>
<a id="__codelineno-7-94" name="__codelineno-7-94" href="#__codelineno-7-94"></a>        <span class="sa">f</span><span class="s2">&quot;*/</span><span class="si">{</span><span class="n">fake</span><span class="o">.</span><span class="n">pystr</span><span class="p">(</span><span class="n">min_chars</span><span class="o">=</span><span class="mi">65</span><span class="p">,</span><span class="w"> </span><span class="n">max_chars</span><span class="o">=</span><span class="mi">65</span><span class="p">)</span><span class="si">}</span><span class="s2">.</span><span class="si">{</span><span class="n">fake</span><span class="o">.</span><span class="n">domain_name</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
<a id="__codelineno-7-95" name="__codelineno-7-95" href="#__codelineno-7-95"></a>    <span class="p">],</span>
<a id="__codelineno-7-96" name="__codelineno-7-96" href="#__codelineno-7-96"></a><span class="p">)</span>
<a id="__codelineno-7-97" name="__codelineno-7-97" href="#__codelineno-7-97"></a><span class="k">def</span> <span class="nf">test_egress_disallow_hosts_with_domain_labels_above_maximum_characters</span><span class="p">(</span><span class="n">fqdn_schema_data</span><span class="p">):</span>
<a id="__codelineno-7-98" name="__codelineno-7-98" href="#__codelineno-7-98"></a>    <span class="c1"># when</span>
<a id="__codelineno-7-99" name="__codelineno-7-99" href="#__codelineno-7-99"></a>    <span class="n">egress_data</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;hosts&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">fqdn_schema_data</span><span class="p">]}</span>
<a id="__codelineno-7-100" name="__codelineno-7-100" href="#__codelineno-7-100"></a>
<a id="__codelineno-7-101" name="__codelineno-7-101" href="#__codelineno-7-101"></a>    <span class="c1"># then</span>
<a id="__codelineno-7-102" name="__codelineno-7-102" href="#__codelineno-7-102"></a>    <span class="k">with</span> <span class="n">pytest</span><span class="o">.</span><span class="n">raises</span><span class="p">(</span>
<a id="__codelineno-7-103" name="__codelineno-7-103" href="#__codelineno-7-103"></a>        <span class="n">ValidationError</span><span class="p">,</span> <span class="n">match</span><span class="o">=</span><span class="s2">&quot;Valid character length for each domain label between 1-63.&quot;</span>
<a id="__codelineno-7-104" name="__codelineno-7-104" href="#__codelineno-7-104"></a>    <span class="p">):</span>
<a id="__codelineno-7-105" name="__codelineno-7-105" href="#__codelineno-7-105"></a>        <span class="n">parse_obj_as</span><span class="p">(</span><span class="n">Egress</span><span class="p">,</span> <span class="n">egress_data</span><span class="p">)</span>
<a id="__codelineno-7-106" name="__codelineno-7-106" href="#__codelineno-7-106"></a>
<a id="__codelineno-7-107" name="__codelineno-7-107" href="#__codelineno-7-107"></a>
<a id="__codelineno-7-108" name="__codelineno-7-108" href="#__codelineno-7-108"></a><span class="nd">@pytest</span><span class="o">.</span><span class="n">mark</span><span class="o">.</span><span class="n">parametrize</span><span class="p">(</span>
<a id="__codelineno-7-109" name="__codelineno-7-109" href="#__codelineno-7-109"></a>    <span class="s2">&quot;fqdn_schema_data&quot;</span><span class="p">,</span>
<a id="__codelineno-7-110" name="__codelineno-7-110" href="#__codelineno-7-110"></a>    <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;*/</span><span class="si">{</span><span class="p">(</span><span class="n">fake</span><span class="o">.</span><span class="n">pystr</span><span class="p">(</span><span class="n">max_chars</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s1">&#39;.&#39;</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">129</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">fake</span><span class="o">.</span><span class="n">pystr</span><span class="p">(</span><span class="n">max_chars</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">],</span>
<a id="__codelineno-7-111" name="__codelineno-7-111" href="#__codelineno-7-111"></a><span class="p">)</span>
<a id="__codelineno-7-112" name="__codelineno-7-112" href="#__codelineno-7-112"></a><span class="k">def</span> <span class="nf">test_egress_disallow_hosts_with_domain_labels_above_maximum</span><span class="p">(</span><span class="n">fqdn_schema_data</span><span class="p">):</span>
<a id="__codelineno-7-113" name="__codelineno-7-113" href="#__codelineno-7-113"></a>    <span class="c1"># when</span>
<a id="__codelineno-7-114" name="__codelineno-7-114" href="#__codelineno-7-114"></a>    <span class="n">egress_data</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;hosts&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">fqdn_schema_data</span><span class="p">]}</span>
<a id="__codelineno-7-115" name="__codelineno-7-115" href="#__codelineno-7-115"></a>
<a id="__codelineno-7-116" name="__codelineno-7-116" href="#__codelineno-7-116"></a>    <span class="c1"># then</span>
<a id="__codelineno-7-117" name="__codelineno-7-117" href="#__codelineno-7-117"></a>    <span class="k">with</span> <span class="n">pytest</span><span class="o">.</span><span class="n">raises</span><span class="p">(</span>
<a id="__codelineno-7-118" name="__codelineno-7-118" href="#__codelineno-7-118"></a>        <span class="n">ValidationError</span><span class="p">,</span> <span class="n">match</span><span class="o">=</span><span class="s2">&quot;Valid number of domain labels for host FQDN between 1 and 127.&quot;</span>
<a id="__codelineno-7-119" name="__codelineno-7-119" href="#__codelineno-7-119"></a>    <span class="p">):</span>
<a id="__codelineno-7-120" name="__codelineno-7-120" href="#__codelineno-7-120"></a>        <span class="n">parse_obj_as</span><span class="p">(</span><span class="n">Egress</span><span class="p">,</span> <span class="n">egress_data</span><span class="p">)</span>
<a id="__codelineno-7-121" name="__codelineno-7-121" href="#__codelineno-7-121"></a>
<a id="__codelineno-7-122" name="__codelineno-7-122" href="#__codelineno-7-122"></a>
<a id="__codelineno-7-123" name="__codelineno-7-123" href="#__codelineno-7-123"></a><span class="nd">@pytest</span><span class="o">.</span><span class="n">mark</span><span class="o">.</span><span class="n">parametrize</span><span class="p">(</span>
<a id="__codelineno-7-124" name="__codelineno-7-124" href="#__codelineno-7-124"></a>    <span class="s2">&quot;fqdn_schema_data&quot;</span><span class="p">,</span>
<a id="__codelineno-7-125" name="__codelineno-7-125" href="#__codelineno-7-125"></a>    <span class="p">[</span>
<a id="__codelineno-7-126" name="__codelineno-7-126" href="#__codelineno-7-126"></a>        <span class="sa">f</span><span class="s2">&quot;*/</span><span class="si">{</span><span class="n">fake</span><span class="o">.</span><span class="n">pystr</span><span class="p">()</span><span class="si">}</span><span class="s2">.</span><span class="si">{</span><span class="n">fake</span><span class="o">.</span><span class="n">pyint</span><span class="p">(</span><span class="n">minval</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
<a id="__codelineno-7-127" name="__codelineno-7-127" href="#__codelineno-7-127"></a>        <span class="sa">f</span><span class="s2">&quot;*/</span><span class="si">{</span><span class="n">fake</span><span class="o">.</span><span class="n">pystr</span><span class="p">()</span><span class="si">}</span><span class="s2">.</span><span class="si">{</span><span class="n">fake</span><span class="o">.</span><span class="n">pyint</span><span class="p">(</span><span class="n">minval</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="si">}{</span><span class="n">fake</span><span class="o">.</span><span class="n">pystr</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
<a id="__codelineno-7-128" name="__codelineno-7-128" href="#__codelineno-7-128"></a>        <span class="sa">f</span><span class="s2">&quot;external/</span><span class="si">{</span><span class="n">fake</span><span class="o">.</span><span class="n">pystr</span><span class="p">()</span><span class="si">}</span><span class="s2">.</span><span class="si">{</span><span class="n">fake</span><span class="o">.</span><span class="n">pyint</span><span class="p">(</span><span class="n">minval</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
<a id="__codelineno-7-129" name="__codelineno-7-129" href="#__codelineno-7-129"></a>        <span class="sa">f</span><span class="s2">&quot;external/</span><span class="si">{</span><span class="n">fake</span><span class="o">.</span><span class="n">pystr</span><span class="p">()</span><span class="si">}</span><span class="s2">.</span><span class="si">{</span><span class="n">fake</span><span class="o">.</span><span class="n">pyint</span><span class="p">(</span><span class="n">minval</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="si">}{</span><span class="n">fake</span><span class="o">.</span><span class="n">pystr</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
<a id="__codelineno-7-130" name="__codelineno-7-130" href="#__codelineno-7-130"></a>    <span class="p">],</span>
<a id="__codelineno-7-131" name="__codelineno-7-131" href="#__codelineno-7-131"></a><span class="p">)</span>
<a id="__codelineno-7-132" name="__codelineno-7-132" href="#__codelineno-7-132"></a><span class="k">def</span> <span class="nf">test_egress_disallow_hosts_if_tld_begins_with_numeric_or_contains_only_numerics</span><span class="p">(</span>
<a id="__codelineno-7-133" name="__codelineno-7-133" href="#__codelineno-7-133"></a>    <span class="n">fqdn_schema_data</span><span class="p">,</span>
<a id="__codelineno-7-134" name="__codelineno-7-134" href="#__codelineno-7-134"></a><span class="p">):</span>
<a id="__codelineno-7-135" name="__codelineno-7-135" href="#__codelineno-7-135"></a>    <span class="c1"># when</span>
<a id="__codelineno-7-136" name="__codelineno-7-136" href="#__codelineno-7-136"></a>    <span class="n">egress_data</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;hosts&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">fqdn_schema_data</span><span class="p">]}</span>
<a id="__codelineno-7-137" name="__codelineno-7-137" href="#__codelineno-7-137"></a>
<a id="__codelineno-7-138" name="__codelineno-7-138" href="#__codelineno-7-138"></a>    <span class="c1"># then</span>
<a id="__codelineno-7-139" name="__codelineno-7-139" href="#__codelineno-7-139"></a>    <span class="k">with</span> <span class="n">pytest</span><span class="o">.</span><span class="n">raises</span><span class="p">(</span><span class="n">ValidationError</span><span class="p">,</span> <span class="n">match</span><span class="o">=</span><span class="s2">&quot;TLD must not begin with a numeric.&quot;</span><span class="p">):</span>
<a id="__codelineno-7-140" name="__codelineno-7-140" href="#__codelineno-7-140"></a>        <span class="n">parse_obj_as</span><span class="p">(</span><span class="n">Egress</span><span class="p">,</span> <span class="n">egress_data</span><span class="p">)</span>
<a id="__codelineno-7-141" name="__codelineno-7-141" href="#__codelineno-7-141"></a>
<a id="__codelineno-7-142" name="__codelineno-7-142" href="#__codelineno-7-142"></a>
<a id="__codelineno-7-143" name="__codelineno-7-143" href="#__codelineno-7-143"></a><span class="nd">@pytest</span><span class="o">.</span><span class="n">mark</span><span class="o">.</span><span class="n">parametrize</span><span class="p">(</span><span class="s2">&quot;fqdn_schema_data&quot;</span><span class="p">,</span> <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;external/</span><span class="si">{</span><span class="n">fake</span><span class="o">.</span><span class="n">pystr</span><span class="p">()</span><span class="si">}</span><span class="s2">.svc.cluster.local&quot;</span><span class="p">])</span>
<a id="__codelineno-7-144" name="__codelineno-7-144" href="#__codelineno-7-144"></a><span class="k">def</span> <span class="nf">test_egress_disallow_external_hosts_with_missing_service_or_namespace_domain_labels</span><span class="p">(</span>
<a id="__codelineno-7-145" name="__codelineno-7-145" href="#__codelineno-7-145"></a>    <span class="n">fqdn_schema_data</span><span class="p">,</span>
<a id="__codelineno-7-146" name="__codelineno-7-146" href="#__codelineno-7-146"></a><span class="p">):</span>
<a id="__codelineno-7-147" name="__codelineno-7-147" href="#__codelineno-7-147"></a>    <span class="c1"># when</span>
<a id="__codelineno-7-148" name="__codelineno-7-148" href="#__codelineno-7-148"></a>    <span class="n">egress_data</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;hosts&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">fqdn_schema_data</span><span class="p">]}</span>
<a id="__codelineno-7-149" name="__codelineno-7-149" href="#__codelineno-7-149"></a>
<a id="__codelineno-7-150" name="__codelineno-7-150" href="#__codelineno-7-150"></a>    <span class="c1"># then</span>
<a id="__codelineno-7-151" name="__codelineno-7-151" href="#__codelineno-7-151"></a>    <span class="k">with</span> <span class="n">pytest</span><span class="o">.</span><span class="n">raises</span><span class="p">(</span>
<a id="__codelineno-7-152" name="__codelineno-7-152" href="#__codelineno-7-152"></a>        <span class="n">ValidationError</span><span class="p">,</span>
<a id="__codelineno-7-153" name="__codelineno-7-153" href="#__codelineno-7-153"></a>        <span class="n">match</span><span class="o">=</span><span class="s2">&quot;&#39;external/&#39; host FQDNs must include service and namespace domain labels&quot;</span><span class="p">,</span>
<a id="__codelineno-7-154" name="__codelineno-7-154" href="#__codelineno-7-154"></a>    <span class="p">):</span>
<a id="__codelineno-7-155" name="__codelineno-7-155" href="#__codelineno-7-155"></a>        <span class="n">parse_obj_as</span><span class="p">(</span><span class="n">Egress</span><span class="p">,</span> <span class="n">egress_data</span><span class="p">)</span>
<a id="__codelineno-7-156" name="__codelineno-7-156" href="#__codelineno-7-156"></a>
<a id="__codelineno-7-157" name="__codelineno-7-157" href="#__codelineno-7-157"></a>
<a id="__codelineno-7-158" name="__codelineno-7-158" href="#__codelineno-7-158"></a><span class="nd">@pytest</span><span class="o">.</span><span class="n">mark</span><span class="o">.</span><span class="n">parametrize</span><span class="p">(</span>
<a id="__codelineno-7-159" name="__codelineno-7-159" href="#__codelineno-7-159"></a>    <span class="s2">&quot;fqdn_schema_data&quot;</span><span class="p">,</span>
<a id="__codelineno-7-160" name="__codelineno-7-160" href="#__codelineno-7-160"></a>    <span class="p">[</span>
<a id="__codelineno-7-161" name="__codelineno-7-161" href="#__codelineno-7-161"></a>        <span class="sa">f</span><span class="s2">&quot;external/</span><span class="si">{</span><span class="n">fake</span><span class="o">.</span><span class="n">pystr</span><span class="p">()</span><span class="si">}</span><span class="s2">.</span><span class="si">{</span><span class="n">fake</span><span class="o">.</span><span class="n">pystr</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
<a id="__codelineno-7-162" name="__codelineno-7-162" href="#__codelineno-7-162"></a>        <span class="sa">f</span><span class="s2">&quot;external/</span><span class="si">{</span><span class="n">fake</span><span class="o">.</span><span class="n">pystr</span><span class="p">()</span><span class="si">}</span><span class="s2">.</span><span class="si">{</span><span class="n">fake</span><span class="o">.</span><span class="n">pystr</span><span class="p">()</span><span class="si">}</span><span class="s2">.svc&quot;</span><span class="p">,</span>
<a id="__codelineno-7-163" name="__codelineno-7-163" href="#__codelineno-7-163"></a>        <span class="sa">f</span><span class="s2">&quot;external/</span><span class="si">{</span><span class="n">fake</span><span class="o">.</span><span class="n">pystr</span><span class="p">()</span><span class="si">}</span><span class="s2">.</span><span class="si">{</span><span class="n">fake</span><span class="o">.</span><span class="n">pystr</span><span class="p">()</span><span class="si">}</span><span class="s2">.svc.cluster&quot;</span><span class="p">,</span>
<a id="__codelineno-7-164" name="__codelineno-7-164" href="#__codelineno-7-164"></a>    <span class="p">],</span>
<a id="__codelineno-7-165" name="__codelineno-7-165" href="#__codelineno-7-165"></a><span class="p">)</span>
<a id="__codelineno-7-166" name="__codelineno-7-166" href="#__codelineno-7-166"></a><span class="k">def</span> <span class="nf">test_egress_disallow_external_hosts_with_missing_cluster_dns_suffix</span><span class="p">(</span><span class="n">fqdn_schema_data</span><span class="p">):</span>
<a id="__codelineno-7-167" name="__codelineno-7-167" href="#__codelineno-7-167"></a>    <span class="c1"># when</span>
<a id="__codelineno-7-168" name="__codelineno-7-168" href="#__codelineno-7-168"></a>    <span class="n">egress_data</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;hosts&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">fqdn_schema_data</span><span class="p">]}</span>
<a id="__codelineno-7-169" name="__codelineno-7-169" href="#__codelineno-7-169"></a>
<a id="__codelineno-7-170" name="__codelineno-7-170" href="#__codelineno-7-170"></a>    <span class="c1"># then</span>
<a id="__codelineno-7-171" name="__codelineno-7-171" href="#__codelineno-7-171"></a>    <span class="k">with</span> <span class="n">pytest</span><span class="o">.</span><span class="n">raises</span><span class="p">(</span>
<a id="__codelineno-7-172" name="__codelineno-7-172" href="#__codelineno-7-172"></a>        <span class="n">ValidationError</span><span class="p">,</span> <span class="n">match</span><span class="o">=</span><span class="s2">&quot;&#39;external/&#39; host FQDNs must contain the cluster DNS suffix.&quot;</span>
<a id="__codelineno-7-173" name="__codelineno-7-173" href="#__codelineno-7-173"></a>    <span class="p">):</span>
<a id="__codelineno-7-174" name="__codelineno-7-174" href="#__codelineno-7-174"></a>        <span class="n">parse_obj_as</span><span class="p">(</span><span class="n">Egress</span><span class="p">,</span> <span class="n">egress_data</span><span class="p">)</span>
<a id="__codelineno-7-175" name="__codelineno-7-175" href="#__codelineno-7-175"></a>
<a id="__codelineno-7-176" name="__codelineno-7-176" href="#__codelineno-7-176"></a>
<a id="__codelineno-7-177" name="__codelineno-7-177" href="#__codelineno-7-177"></a><span class="nd">@pytest</span><span class="o">.</span><span class="n">mark</span><span class="o">.</span><span class="n">parametrize</span><span class="p">(</span>
<a id="__codelineno-7-178" name="__codelineno-7-178" href="#__codelineno-7-178"></a>    <span class="s2">&quot;egress_schema_data&quot;</span><span class="p">,</span>
<a id="__codelineno-7-179" name="__codelineno-7-179" href="#__codelineno-7-179"></a>    <span class="p">[</span>
<a id="__codelineno-7-180" name="__codelineno-7-180" href="#__codelineno-7-180"></a>        <span class="sa">f</span><span class="s2">&quot;external/</span><span class="si">{</span><span class="n">fake</span><span class="o">.</span><span class="n">pystr</span><span class="p">()</span><span class="si">}</span><span class="s2">.</span><span class="si">{</span><span class="n">fake</span><span class="o">.</span><span class="n">pystr</span><span class="p">()</span><span class="si">}</span><span class="s2">.svc.cluster.local&quot;</span><span class="p">,</span>
<a id="__codelineno-7-181" name="__codelineno-7-181" href="#__codelineno-7-181"></a>        <span class="sa">f</span><span class="s2">&quot;external/</span><span class="si">{</span><span class="p">(</span><span class="n">fake</span><span class="o">.</span><span class="n">pystr</span><span class="p">(</span><span class="n">max_chars</span><span class="o">=</span><span class="mi">63</span><span class="p">,</span><span class="w"> </span><span class="n">min_chars</span><span class="o">=</span><span class="mi">63</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s1">&#39;.&#39;</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">2</span><span class="si">}</span><span class="s2">svc.cluster.local&quot;</span><span class="p">,</span>
<a id="__codelineno-7-182" name="__codelineno-7-182" href="#__codelineno-7-182"></a>        <span class="sa">f</span><span class="s2">&quot;external/</span><span class="si">{</span><span class="p">(</span><span class="n">fake</span><span class="o">.</span><span class="n">pystr</span><span class="p">(</span><span class="n">max_chars</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s1">&#39;.&#39;</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">2</span><span class="si">}</span><span class="s2">svc.cluster.local&quot;</span><span class="p">,</span>
<a id="__codelineno-7-183" name="__codelineno-7-183" href="#__codelineno-7-183"></a>        <span class="sa">f</span><span class="s2">&quot;external/</span><span class="si">{</span><span class="p">(</span><span class="n">fake</span><span class="o">.</span><span class="n">pystr</span><span class="p">(</span><span class="n">max_chars</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s1">&#39;.&#39;</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">50</span><span class="si">}</span><span class="s2">svc.cluster.local&quot;</span><span class="p">,</span>
<a id="__codelineno-7-184" name="__codelineno-7-184" href="#__codelineno-7-184"></a>        <span class="sa">f</span><span class="s2">&quot;*/</span><span class="si">{</span><span class="n">fake</span><span class="o">.</span><span class="n">domain_name</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
<a id="__codelineno-7-185" name="__codelineno-7-185" href="#__codelineno-7-185"></a>        <span class="sa">f</span><span class="s2">&quot;*/</span><span class="si">{</span><span class="n">fake</span><span class="o">.</span><span class="n">pystr</span><span class="p">(</span><span class="n">max_chars</span><span class="o">=</span><span class="mi">63</span><span class="p">,</span><span class="w"> </span><span class="n">min_chars</span><span class="o">=</span><span class="mi">63</span><span class="p">)</span><span class="si">}</span><span class="s2">.com&quot;</span><span class="p">,</span>
<a id="__codelineno-7-186" name="__codelineno-7-186" href="#__codelineno-7-186"></a>        <span class="sa">f</span><span class="s2">&quot;*/</span><span class="si">{</span><span class="p">(</span><span class="n">fake</span><span class="o">.</span><span class="n">pystr</span><span class="p">(</span><span class="n">max_chars</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s1">&#39;.&#39;</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">50</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">fake</span><span class="o">.</span><span class="n">pystr</span><span class="p">(</span><span class="n">max_chars</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
<a id="__codelineno-7-187" name="__codelineno-7-187" href="#__codelineno-7-187"></a>        <span class="sa">f</span><span class="s2">&quot;*/</span><span class="si">{</span><span class="n">fake</span><span class="o">.</span><span class="n">domain_name</span><span class="p">()</span><span class="si">}{</span><span class="n">fake</span><span class="o">.</span><span class="n">pyint</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
<a id="__codelineno-7-188" name="__codelineno-7-188" href="#__codelineno-7-188"></a>        <span class="sa">f</span><span class="s2">&quot;*/</span><span class="si">{</span><span class="n">fake</span><span class="o">.</span><span class="n">domain_name</span><span class="p">()</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">,</span>
<a id="__codelineno-7-189" name="__codelineno-7-189" href="#__codelineno-7-189"></a>    <span class="p">],</span>
<a id="__codelineno-7-190" name="__codelineno-7-190" href="#__codelineno-7-190"></a><span class="p">)</span>
<a id="__codelineno-7-191" name="__codelineno-7-191" href="#__codelineno-7-191"></a><span class="k">def</span> <span class="nf">test_egress_valid_hosts_fqdn</span><span class="p">(</span><span class="n">egress_schema_data</span><span class="p">):</span>
<a id="__codelineno-7-192" name="__codelineno-7-192" href="#__codelineno-7-192"></a>    <span class="c1"># when</span>
<a id="__codelineno-7-193" name="__codelineno-7-193" href="#__codelineno-7-193"></a>
<a id="__codelineno-7-194" name="__codelineno-7-194" href="#__codelineno-7-194"></a>    <span class="n">egress_data</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;hosts&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">egress_schema_data</span><span class="p">]}</span>
<a id="__codelineno-7-195" name="__codelineno-7-195" href="#__codelineno-7-195"></a>    <span class="n">parsed</span> <span class="o">=</span> <span class="n">parse_obj_as</span><span class="p">(</span><span class="n">Egress</span><span class="p">,</span> <span class="n">egress_data</span><span class="p">)</span>
<a id="__codelineno-7-196" name="__codelineno-7-196" href="#__codelineno-7-196"></a>
<a id="__codelineno-7-197" name="__codelineno-7-197" href="#__codelineno-7-197"></a>    <span class="c1"># then</span>
<a id="__codelineno-7-198" name="__codelineno-7-198" href="#__codelineno-7-198"></a>    <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">parsed</span><span class="o">.</span><span class="n">hosts</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nb">str</span><span class="p">)</span>
</code></pre></div>
<p>The test cases are in a good enough state that refactoring the code should be relatively simple.</p>
<h2 id="refactoring">Refactoring</h2>
<p>There are a number of issues with the code:</p>
<ol>
<li>Nested if statement introduce unnecessary complexity.  The nested statements can be eliminated  by creating a function that validates each scenario, with an additional benefit of eliminating duplicate code.</li>
<li>For loop iterates through each value in <code>hosts</code>.  If there is a way that the validator method could validate each item in the field, it would drastically reduce code complexity.</li>
<li>Each scenario is not standardized.  During the refactor, if each scenario's inputs and outputs can be standardized, this would make the code a bit more readable.</li>
</ol>
<p>Standardizing each function is the first step in the refactor.  Each scenario has expected inputs and outputs, although some require <code>assert</code> statements, and others require <code>assert not</code> statements.  Each scenario expects a regex pattern and an error message to be passed in as input, and will raise a value error if the scenario fails:</p>
<div class="highlight"><span class="filename">src/service_dependency_schema.py</span><pre><span></span><code><a id="__codelineno-8-1" name="__codelineno-8-1" href="#__codelineno-8-1"></a><span class="o">...</span>
<a id="__codelineno-8-2" name="__codelineno-8-2" href="#__codelineno-8-2"></a><span class="k">class</span> <span class="nc">Egress</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">,</span> <span class="n">extra</span><span class="o">=</span><span class="s2">&quot;forbid&quot;</span><span class="p">):</span>
<a id="__codelineno-8-3" name="__codelineno-8-3" href="#__codelineno-8-3"></a>    <span class="n">port</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Port</span><span class="p">]</span>
<a id="__codelineno-8-4" name="__codelineno-8-4" href="#__codelineno-8-4"></a>    <span class="n">hosts</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span>
<a id="__codelineno-8-5" name="__codelineno-8-5" href="#__codelineno-8-5"></a>
<a id="__codelineno-8-6" name="__codelineno-8-6" href="#__codelineno-8-6"></a>    <span class="nd">@staticmethod</span>   <span class="c1"># (1)</span>
<a id="__codelineno-8-7" name="__codelineno-8-7" href="#__codelineno-8-7"></a>    <span class="k">def</span> <span class="nf">fqdn_has_slash_prefix</span><span class="p">(</span><span class="n">fqdn</span><span class="p">):</span>
<a id="__codelineno-8-8" name="__codelineno-8-8" href="#__codelineno-8-8"></a>        <span class="n">message</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Invalid FQDN.  Must include &#39;*/&#39; or &#39;external/&#39; prefix.&quot;</span>
<a id="__codelineno-8-9" name="__codelineno-8-9" href="#__codelineno-8-9"></a>        <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-8-10" name="__codelineno-8-10" href="#__codelineno-8-10"></a>            <span class="k">assert</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="s2">&quot;^(\*|external)\/.+$&quot;</span><span class="p">,</span> <span class="n">fqdn</span><span class="p">)</span>
<a id="__codelineno-8-11" name="__codelineno-8-11" href="#__codelineno-8-11"></a>        <span class="k">except</span> <span class="ne">AssertionError</span><span class="p">:</span>
<a id="__codelineno-8-12" name="__codelineno-8-12" href="#__codelineno-8-12"></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">message</span><span class="p">)</span> <span class="kn">from</span> <span class="kc">None</span>
<a id="__codelineno-8-13" name="__codelineno-8-13" href="#__codelineno-8-13"></a>
<a id="__codelineno-8-14" name="__codelineno-8-14" href="#__codelineno-8-14"></a>    <span class="nd">@staticmethod</span>
<a id="__codelineno-8-15" name="__codelineno-8-15" href="#__codelineno-8-15"></a>    <span class="k">def</span> <span class="nf">disallow_url_schema</span><span class="p">(</span><span class="n">fqdn</span><span class="p">):</span>
<a id="__codelineno-8-16" name="__codelineno-8-16" href="#__codelineno-8-16"></a>        <span class="n">message</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Host FQDN cannot begin with &#39;://&#39; schema.&quot;</span>
<a id="__codelineno-8-17" name="__codelineno-8-17" href="#__codelineno-8-17"></a>        <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-8-18" name="__codelineno-8-18" href="#__codelineno-8-18"></a>            <span class="k">assert</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="s2">&quot;^(\*|external)\/((?!.+:\/\/).+)$&quot;</span><span class="p">,</span> <span class="n">fqdn</span><span class="p">)</span>
<a id="__codelineno-8-19" name="__codelineno-8-19" href="#__codelineno-8-19"></a>        <span class="k">except</span> <span class="ne">AssertionError</span><span class="p">:</span>
<a id="__codelineno-8-20" name="__codelineno-8-20" href="#__codelineno-8-20"></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">message</span><span class="p">)</span> <span class="kn">from</span> <span class="kc">None</span>
<a id="__codelineno-8-21" name="__codelineno-8-21" href="#__codelineno-8-21"></a>
<a id="__codelineno-8-22" name="__codelineno-8-22" href="#__codelineno-8-22"></a>    <span class="nd">@staticmethod</span>
<a id="__codelineno-8-23" name="__codelineno-8-23" href="#__codelineno-8-23"></a>    <span class="k">def</span> <span class="nf">fqdn_domain_label_constraints</span><span class="p">(</span><span class="n">fqdn</span><span class="p">):</span>
<a id="__codelineno-8-24" name="__codelineno-8-24" href="#__codelineno-8-24"></a>        <span class="n">message</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Valid number of domain labels for host FQDN between 1 and 127.&quot;</span>
<a id="__codelineno-8-25" name="__codelineno-8-25" href="#__codelineno-8-25"></a>        <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-8-26" name="__codelineno-8-26" href="#__codelineno-8-26"></a>            <span class="k">assert</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="s2">&quot;^(\*|external)\/([A-Za-z0-9-]+\.){1,127}[A-Za-z0-9-]+\.?$&quot;</span><span class="p">,</span> <span class="n">fqdn</span><span class="p">)</span>
<a id="__codelineno-8-27" name="__codelineno-8-27" href="#__codelineno-8-27"></a>        <span class="k">except</span> <span class="ne">AssertionError</span><span class="p">:</span>
<a id="__codelineno-8-28" name="__codelineno-8-28" href="#__codelineno-8-28"></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">message</span><span class="p">)</span> <span class="kn">from</span> <span class="kc">None</span>
<a id="__codelineno-8-29" name="__codelineno-8-29" href="#__codelineno-8-29"></a>
<a id="__codelineno-8-30" name="__codelineno-8-30" href="#__codelineno-8-30"></a>    <span class="nd">@staticmethod</span>
<a id="__codelineno-8-31" name="__codelineno-8-31" href="#__codelineno-8-31"></a>    <span class="k">def</span> <span class="nf">fqdn_character_length</span><span class="p">(</span><span class="n">fqdn</span><span class="p">):</span>
<a id="__codelineno-8-32" name="__codelineno-8-32" href="#__codelineno-8-32"></a>        <span class="n">message</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Valid character length for host FQDN between 1 and 255.&quot;</span>
<a id="__codelineno-8-33" name="__codelineno-8-33" href="#__codelineno-8-33"></a>        <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-8-34" name="__codelineno-8-34" href="#__codelineno-8-34"></a>            <span class="k">assert</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="s2">&quot;^(\*|external)\/((?=.{1,255}$).+$)&quot;</span><span class="p">,</span> <span class="n">fqdn</span><span class="p">)</span>
<a id="__codelineno-8-35" name="__codelineno-8-35" href="#__codelineno-8-35"></a>        <span class="k">except</span> <span class="ne">AssertionError</span><span class="p">:</span>
<a id="__codelineno-8-36" name="__codelineno-8-36" href="#__codelineno-8-36"></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">message</span><span class="p">)</span> <span class="kn">from</span> <span class="kc">None</span>
<a id="__codelineno-8-37" name="__codelineno-8-37" href="#__codelineno-8-37"></a>
<a id="__codelineno-8-38" name="__codelineno-8-38" href="#__codelineno-8-38"></a>    <span class="nd">@staticmethod</span>
<a id="__codelineno-8-39" name="__codelineno-8-39" href="#__codelineno-8-39"></a>    <span class="k">def</span> <span class="nf">fqdn_domain_label_character_length</span><span class="p">(</span><span class="n">fqdn</span><span class="p">):</span>
<a id="__codelineno-8-40" name="__codelineno-8-40" href="#__codelineno-8-40"></a>        <span class="n">message</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Valid character length for each domain label between 1-63.&quot;</span>
<a id="__codelineno-8-41" name="__codelineno-8-41" href="#__codelineno-8-41"></a>        <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-8-42" name="__codelineno-8-42" href="#__codelineno-8-42"></a>            <span class="k">assert</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="s2">&quot;^(\*|external)\/((.{1,63}\.).+$)&quot;</span><span class="p">,</span> <span class="n">fqdn</span><span class="p">)</span>
<a id="__codelineno-8-43" name="__codelineno-8-43" href="#__codelineno-8-43"></a>        <span class="k">except</span> <span class="ne">AssertionError</span><span class="p">:</span>
<a id="__codelineno-8-44" name="__codelineno-8-44" href="#__codelineno-8-44"></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">message</span><span class="p">)</span> <span class="kn">from</span> <span class="kc">None</span>
<a id="__codelineno-8-45" name="__codelineno-8-45" href="#__codelineno-8-45"></a>
<a id="__codelineno-8-46" name="__codelineno-8-46" href="#__codelineno-8-46"></a>    <span class="nd">@staticmethod</span>
<a id="__codelineno-8-47" name="__codelineno-8-47" href="#__codelineno-8-47"></a>    <span class="k">def</span> <span class="nf">tld_numerics_constraints</span><span class="p">(</span><span class="n">fqdn</span><span class="p">):</span>
<a id="__codelineno-8-48" name="__codelineno-8-48" href="#__codelineno-8-48"></a>        <span class="n">message</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;TLD must not begin with a numeric, or contain only numerics.&quot;</span>
<a id="__codelineno-8-49" name="__codelineno-8-49" href="#__codelineno-8-49"></a>        <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-8-50" name="__codelineno-8-50" href="#__codelineno-8-50"></a>            <span class="k">assert</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="s2">&quot;^(\*|external)\/(.+\.(?![0-9])[A-Za-z0-9-]+)\.?$&quot;</span><span class="p">,</span> <span class="n">fqdn</span><span class="p">)</span>
<a id="__codelineno-8-51" name="__codelineno-8-51" href="#__codelineno-8-51"></a>        <span class="k">except</span> <span class="ne">AssertionError</span><span class="p">:</span>
<a id="__codelineno-8-52" name="__codelineno-8-52" href="#__codelineno-8-52"></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">message</span><span class="p">)</span> <span class="kn">from</span> <span class="kc">None</span>
<a id="__codelineno-8-53" name="__codelineno-8-53" href="#__codelineno-8-53"></a>
<a id="__codelineno-8-54" name="__codelineno-8-54" href="#__codelineno-8-54"></a>    <span class="nd">@staticmethod</span>
<a id="__codelineno-8-55" name="__codelineno-8-55" href="#__codelineno-8-55"></a>    <span class="k">def</span> <span class="nf">external_slashed_fqdn_has_service_and_namespace_domain_labels</span><span class="p">(</span><span class="n">fqdn</span><span class="p">):</span>
<a id="__codelineno-8-56" name="__codelineno-8-56" href="#__codelineno-8-56"></a>        <span class="n">message</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;&#39;external/&#39; host FQDNs must include service and namespace domain labels.&quot;</span>
<a id="__codelineno-8-57" name="__codelineno-8-57" href="#__codelineno-8-57"></a>        <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-8-58" name="__codelineno-8-58" href="#__codelineno-8-58"></a>            <span class="k">assert</span> <span class="ow">not</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="s2">&quot;^external\/[A-Za-z0-9-]+\.(?=svc\.cluster\.local$)&quot;</span><span class="p">,</span> <span class="n">fqdn</span><span class="p">)</span>
<a id="__codelineno-8-59" name="__codelineno-8-59" href="#__codelineno-8-59"></a>        <span class="k">except</span> <span class="ne">AssertionError</span><span class="p">:</span>
<a id="__codelineno-8-60" name="__codelineno-8-60" href="#__codelineno-8-60"></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">message</span><span class="p">)</span> <span class="kn">from</span> <span class="kc">None</span>
<a id="__codelineno-8-61" name="__codelineno-8-61" href="#__codelineno-8-61"></a>
<a id="__codelineno-8-62" name="__codelineno-8-62" href="#__codelineno-8-62"></a>    <span class="nd">@staticmethod</span>
<a id="__codelineno-8-63" name="__codelineno-8-63" href="#__codelineno-8-63"></a>    <span class="k">def</span> <span class="nf">external_slashed_fqdn_has_cluster_dns_suffix</span><span class="p">(</span><span class="n">fqdn</span><span class="p">):</span>
<a id="__codelineno-8-64" name="__codelineno-8-64" href="#__codelineno-8-64"></a>        <span class="n">message</span> <span class="o">=</span> <span class="p">(</span>
<a id="__codelineno-8-65" name="__codelineno-8-65" href="#__codelineno-8-65"></a>            <span class="sa">f</span><span class="s2">&quot;&#39;external/&#39; host FQDNs must contain the cluster DNS suffix.&quot;</span>
<a id="__codelineno-8-66" name="__codelineno-8-66" href="#__codelineno-8-66"></a>
<a id="__codelineno-8-67" name="__codelineno-8-67" href="#__codelineno-8-67"></a>    <span class="nd">@validator</span><span class="p">(</span><span class="s2">&quot;hosts&quot;</span><span class="p">,</span> <span class="n">each_item</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="c1"># (2)</span>
<a id="__codelineno-8-68" name="__codelineno-8-68" href="#__codelineno-8-68"></a>    <span class="k">def</span> <span class="nf">hosts_fqdn_must_be_valid</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">v</span><span class="p">):</span>
<a id="__codelineno-8-69" name="__codelineno-8-69" href="#__codelineno-8-69"></a>        <span class="bp">cls</span><span class="o">.</span><span class="n">fqdn_has_slash_prefix</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
<a id="__codelineno-8-70" name="__codelineno-8-70" href="#__codelineno-8-70"></a>        <span class="bp">cls</span><span class="o">.</span><span class="n">disallow_url_schema</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
<a id="__codelineno-8-71" name="__codelineno-8-71" href="#__codelineno-8-71"></a>        <span class="bp">cls</span><span class="o">.</span><span class="n">fqdn_domain_label_constraints</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
<a id="__codelineno-8-72" name="__codelineno-8-72" href="#__codelineno-8-72"></a>        <span class="bp">cls</span><span class="o">.</span><span class="n">fqdn_character_length</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
<a id="__codelineno-8-73" name="__codelineno-8-73" href="#__codelineno-8-73"></a>        <span class="bp">cls</span><span class="o">.</span><span class="n">fqdn_domain_label_character_length</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
<a id="__codelineno-8-74" name="__codelineno-8-74" href="#__codelineno-8-74"></a>        <span class="bp">cls</span><span class="o">.</span><span class="n">tld_numerics_constraints</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
<a id="__codelineno-8-75" name="__codelineno-8-75" href="#__codelineno-8-75"></a>        <span class="k">if</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="s2">&quot;^external\/.+$&quot;</span><span class="p">,</span> <span class="n">v</span><span class="p">):</span>
<a id="__codelineno-8-76" name="__codelineno-8-76" href="#__codelineno-8-76"></a>            <span class="bp">cls</span><span class="o">.</span><span class="n">external_slashed_fqdn_has_service_and_namespace_domain_labels</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
<a id="__codelineno-8-77" name="__codelineno-8-77" href="#__codelineno-8-77"></a>            <span class="bp">cls</span><span class="o">.</span><span class="n">external_slashed_fqdn_has_cluster_dns_suffix</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
<a id="__codelineno-8-78" name="__codelineno-8-78" href="#__codelineno-8-78"></a>
<a id="__codelineno-8-79" name="__codelineno-8-79" href="#__codelineno-8-79"></a>        <span class="k">return</span> <span class="n">v</span>
<a id="__codelineno-8-80" name="__codelineno-8-80" href="#__codelineno-8-80"></a><span class="o">...</span>
</code></pre></div>
<ol>
<li>Static methods are created for each validation scenario to reduce duplicate code</li>
<li>The <code>hosts_fqdn_must_be_valid</code> validator method now validates against each item in the <code>hosts</code> field.  Additionally, since the static methods are being called, nested statements are nearly eliminated</li>
</ol>
<p>Additionally, the <code>validator</code> decorator allows validation of iterable fields with the <code>each_item</code> parameter.  Setting <code>each_item=True</code> eliminates the for loop from the first iteration of code.  The next step now is to improve the way that input data for each scenario is handled.  This can be handled like so:</p>
<div class="highlight"><span class="filename">src/constants.py</span><pre><span></span><code><a id="__codelineno-9-1" name="__codelineno-9-1" href="#__codelineno-9-1"></a><span class="c1"># Each constant contains the following:</span>
<a id="__codelineno-9-2" name="__codelineno-9-2" href="#__codelineno-9-2"></a><span class="c1"># (regex_pattern, error_message)</span>
<a id="__codelineno-9-3" name="__codelineno-9-3" href="#__codelineno-9-3"></a><span class="n">FQDN_HAS_SLASH_PREFIX</span> <span class="o">=</span> <span class="p">(</span>
<a id="__codelineno-9-4" name="__codelineno-9-4" href="#__codelineno-9-4"></a>    <span class="s2">&quot;^(\*|external)\/.+$&quot;</span><span class="p">,</span>
<a id="__codelineno-9-5" name="__codelineno-9-5" href="#__codelineno-9-5"></a>    <span class="sa">f</span><span class="s2">&quot;Invalid FQDN.  Must include &#39;*/&#39; or &#39;external/&#39; prefix.&quot;</span><span class="p">,</span>
<a id="__codelineno-9-6" name="__codelineno-9-6" href="#__codelineno-9-6"></a><span class="p">)</span>
<a id="__codelineno-9-7" name="__codelineno-9-7" href="#__codelineno-9-7"></a><span class="n">DISALLOW_URL_SCHEMA</span> <span class="o">=</span> <span class="p">(</span>
<a id="__codelineno-9-8" name="__codelineno-9-8" href="#__codelineno-9-8"></a>    <span class="s2">&quot;^(\*|external)\/((?!.+:\/\/).+)$&quot;</span><span class="p">,</span>
<a id="__codelineno-9-9" name="__codelineno-9-9" href="#__codelineno-9-9"></a>    <span class="sa">f</span><span class="s2">&quot;Host FQDN cannot begin with &#39;://&#39; schema.&quot;</span><span class="p">,</span>
<a id="__codelineno-9-10" name="__codelineno-9-10" href="#__codelineno-9-10"></a><span class="p">)</span>
<a id="__codelineno-9-11" name="__codelineno-9-11" href="#__codelineno-9-11"></a><span class="n">FQDN_DOMAIN_LABEL_CONSTRAINTS</span> <span class="o">=</span> <span class="p">(</span>
<a id="__codelineno-9-12" name="__codelineno-9-12" href="#__codelineno-9-12"></a>    <span class="s2">&quot;^(\*|external)\/([A-Za-z0-9-]+\.){1,127}[A-Za-z0-9-]+\.?$&quot;</span><span class="p">,</span>
<a id="__codelineno-9-13" name="__codelineno-9-13" href="#__codelineno-9-13"></a>    <span class="sa">f</span><span class="s2">&quot;Valid number of domain labels for host FQDN between 1 and 127.&quot;</span><span class="p">,</span>
<a id="__codelineno-9-14" name="__codelineno-9-14" href="#__codelineno-9-14"></a><span class="p">)</span>
<a id="__codelineno-9-15" name="__codelineno-9-15" href="#__codelineno-9-15"></a><span class="n">FQDN_DOMAIN_LABEL_CHARACTER_LENGTH</span> <span class="o">=</span> <span class="p">(</span>
<a id="__codelineno-9-16" name="__codelineno-9-16" href="#__codelineno-9-16"></a>    <span class="s2">&quot;^(\*|external)\/((.{1,63}\.).+$)&quot;</span><span class="p">,</span>
<a id="__codelineno-9-17" name="__codelineno-9-17" href="#__codelineno-9-17"></a>    <span class="sa">f</span><span class="s2">&quot;Valid character length for each domain label between 1-63.&quot;</span><span class="p">,</span>
<a id="__codelineno-9-18" name="__codelineno-9-18" href="#__codelineno-9-18"></a><span class="p">)</span>
<a id="__codelineno-9-19" name="__codelineno-9-19" href="#__codelineno-9-19"></a><span class="n">FQDN_CHARACTER_LENGTH</span> <span class="o">=</span> <span class="p">(</span>
<a id="__codelineno-9-20" name="__codelineno-9-20" href="#__codelineno-9-20"></a>    <span class="s2">&quot;^(\*|external)\/((?=.{1,255}$).+$)&quot;</span><span class="p">,</span>
<a id="__codelineno-9-21" name="__codelineno-9-21" href="#__codelineno-9-21"></a>    <span class="sa">f</span><span class="s2">&quot;Valid character length for host FQDN between 1 and 255.&quot;</span><span class="p">,</span>
<a id="__codelineno-9-22" name="__codelineno-9-22" href="#__codelineno-9-22"></a><span class="p">)</span>
<a id="__codelineno-9-23" name="__codelineno-9-23" href="#__codelineno-9-23"></a><span class="n">TLD_NUMERIC_CONSTRAINTS</span> <span class="o">=</span> <span class="p">(</span>
<a id="__codelineno-9-24" name="__codelineno-9-24" href="#__codelineno-9-24"></a>    <span class="s2">&quot;^(\*|external)\/(.+\.(?![0-9])[A-Za-z0-9-]+)\.?$&quot;</span><span class="p">,</span>
<a id="__codelineno-9-25" name="__codelineno-9-25" href="#__codelineno-9-25"></a>    <span class="sa">f</span><span class="s2">&quot;TLD must not begin with a numeric, or contain only numerics.&quot;</span><span class="p">,</span>
<a id="__codelineno-9-26" name="__codelineno-9-26" href="#__codelineno-9-26"></a><span class="p">)</span>
<a id="__codelineno-9-27" name="__codelineno-9-27" href="#__codelineno-9-27"></a><span class="n">EXTERNAL_SLASHED_FQDN_HAS_SERVICE_AND_NAMESPACE_DOMAIN_LABELS</span> <span class="o">=</span> <span class="p">(</span>
<a id="__codelineno-9-28" name="__codelineno-9-28" href="#__codelineno-9-28"></a>    <span class="s2">&quot;^external\/[A-Za-z0-9-]+\.(?=svc\.cluster\.local$)&quot;</span><span class="p">,</span>
<a id="__codelineno-9-29" name="__codelineno-9-29" href="#__codelineno-9-29"></a>    <span class="sa">f</span><span class="s2">&quot;&#39;external/&#39; host FQDNs must include service and namespace domain labels.&quot;</span><span class="p">,</span>
<a id="__codelineno-9-30" name="__codelineno-9-30" href="#__codelineno-9-30"></a><span class="p">)</span>
<a id="__codelineno-9-31" name="__codelineno-9-31" href="#__codelineno-9-31"></a><span class="n">EXTERNAL_SLASHED_FQDN_HAS_CLUSTER_DNS_SUFFIX</span> <span class="o">=</span> <span class="p">(</span>
<a id="__codelineno-9-32" name="__codelineno-9-32" href="#__codelineno-9-32"></a>    <span class="s2">&quot;^external\/.+\.svc\.cluster\.local$&quot;</span><span class="p">,</span>
<a id="__codelineno-9-33" name="__codelineno-9-33" href="#__codelineno-9-33"></a>    <span class="sa">f</span><span class="s2">&quot;&#39;external/&#39; host FQDNs must contain the cluster DNS suffix.&quot;</span><span class="p">,</span>
<a id="__codelineno-9-34" name="__codelineno-9-34" href="#__codelineno-9-34"></a><span class="p">)</span>
</code></pre></div>
<p>Adding clarity to the contant variable names allows for more readable code.  When reviewing the function <code>fqdn_has_slash_prefix(v)</code>, one can guess that the function checks that an fqdn has a slash prefix.  But if we ran a single function called <code>validate_hosts_fqdn</code>, the code readability increases when used in conjunction with well-named variables.  Therefore, <code>validate_hosts_fqdn(FQDN_HAS_SLASH_PREFIX)</code> adds an extra bit of context to what it is doing.</p>
<h2 id="the-final-result">The Final Result</h2>
<p>Reducing the amount of duplicate code to a single static method greatly improves readability:</p>
<div class="highlight"><span class="filename">src/service_dependency_schema.py</span><pre><span></span><code><a id="__codelineno-10-1" name="__codelineno-10-1" href="#__codelineno-10-1"></a><span class="kn">from</span> <span class="nn">pydantic</span> <span class="kn">import</span> <span class="n">BaseModel</span><span class="p">,</span> <span class="n">ValidationError</span><span class="p">,</span> <span class="n">validation</span><span class="p">,</span> <span class="n">parse_obj_as</span>
<a id="__codelineno-10-2" name="__codelineno-10-2" href="#__codelineno-10-2"></a>
<a id="__codelineno-10-3" name="__codelineno-10-3" href="#__codelineno-10-3"></a><span class="kn">from</span> <span class="nn">constants</span> <span class="kn">import</span> <span class="p">(</span>
<a id="__codelineno-10-4" name="__codelineno-10-4" href="#__codelineno-10-4"></a>    <span class="n">DISALLOW_URL_SCHEMA</span><span class="p">,</span>
<a id="__codelineno-10-5" name="__codelineno-10-5" href="#__codelineno-10-5"></a>    <span class="n">EXTERNAL_SLASHED_FQDN_HAS_CLUSTER_DNS_SUFFIX</span><span class="p">,</span>
<a id="__codelineno-10-6" name="__codelineno-10-6" href="#__codelineno-10-6"></a>    <span class="n">EXTERNAL_SLASHED_FQDN_HAS_SERVICE_AND_NAMESPACE_DOMAIN_LABELS</span><span class="p">,</span>
<a id="__codelineno-10-7" name="__codelineno-10-7" href="#__codelineno-10-7"></a>    <span class="n">FQDN_CHARACTER_LENGTH</span><span class="p">,</span>
<a id="__codelineno-10-8" name="__codelineno-10-8" href="#__codelineno-10-8"></a>    <span class="n">FQDN_DOMAIN_LABEL_CHARACTER_LENGTH</span><span class="p">,</span>
<a id="__codelineno-10-9" name="__codelineno-10-9" href="#__codelineno-10-9"></a>    <span class="n">FQDN_DOMAIN_LABEL_CONSTRAINTS</span><span class="p">,</span>
<a id="__codelineno-10-10" name="__codelineno-10-10" href="#__codelineno-10-10"></a>    <span class="n">FQDN_HAS_SLASH_PREFIX</span><span class="p">,</span>
<a id="__codelineno-10-11" name="__codelineno-10-11" href="#__codelineno-10-11"></a>    <span class="n">LINK_TO_DOCUMENTATION</span><span class="p">,</span>
<a id="__codelineno-10-12" name="__codelineno-10-12" href="#__codelineno-10-12"></a>    <span class="n">TLD_NUMERIC_CONSTRAINTS</span><span class="p">,</span>
<a id="__codelineno-10-13" name="__codelineno-10-13" href="#__codelineno-10-13"></a><span class="p">)</span>
<a id="__codelineno-10-14" name="__codelineno-10-14" href="#__codelineno-10-14"></a>
<a id="__codelineno-10-15" name="__codelineno-10-15" href="#__codelineno-10-15"></a>
<a id="__codelineno-10-16" name="__codelineno-10-16" href="#__codelineno-10-16"></a><span class="k">class</span> <span class="nc">Egress</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">,</span> <span class="n">extra</span><span class="o">=</span><span class="s2">&quot;forbid&quot;</span><span class="p">):</span>
<a id="__codelineno-10-17" name="__codelineno-10-17" href="#__codelineno-10-17"></a>    <span class="n">port</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Port</span><span class="p">]</span>
<a id="__codelineno-10-18" name="__codelineno-10-18" href="#__codelineno-10-18"></a>    <span class="n">hosts</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span>
<a id="__codelineno-10-19" name="__codelineno-10-19" href="#__codelineno-10-19"></a>
<a id="__codelineno-10-20" name="__codelineno-10-20" href="#__codelineno-10-20"></a>    <span class="nd">@staticmethod</span>
<a id="__codelineno-10-21" name="__codelineno-10-21" href="#__codelineno-10-21"></a>    <span class="k">def</span> <span class="nf">validate_hosts_fqdn</span><span class="p">(</span><span class="n">fqdn</span><span class="p">,</span> <span class="n">scenario</span><span class="p">,</span> <span class="n">assert_not</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span> <span class="c1"># (1)</span>
<a id="__codelineno-10-22" name="__codelineno-10-22" href="#__codelineno-10-22"></a>        <span class="n">pattern</span> <span class="o">=</span> <span class="n">scenario</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<a id="__codelineno-10-23" name="__codelineno-10-23" href="#__codelineno-10-23"></a>        <span class="n">message</span> <span class="o">=</span> <span class="n">scenario</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
<a id="__codelineno-10-24" name="__codelineno-10-24" href="#__codelineno-10-24"></a>        <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-10-25" name="__codelineno-10-25" href="#__codelineno-10-25"></a>            <span class="k">if</span> <span class="n">assert_not</span><span class="p">:</span>
<a id="__codelineno-10-26" name="__codelineno-10-26" href="#__codelineno-10-26"></a>                <span class="k">assert</span> <span class="ow">not</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">pattern</span><span class="p">,</span> <span class="n">fqdn</span><span class="p">)</span>
<a id="__codelineno-10-27" name="__codelineno-10-27" href="#__codelineno-10-27"></a>            <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-10-28" name="__codelineno-10-28" href="#__codelineno-10-28"></a>                <span class="k">assert</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">pattern</span><span class="p">,</span> <span class="n">fqdn</span><span class="p">)</span>
<a id="__codelineno-10-29" name="__codelineno-10-29" href="#__codelineno-10-29"></a>        <span class="k">except</span> <span class="ne">AssertionError</span><span class="p">:</span>
<a id="__codelineno-10-30" name="__codelineno-10-30" href="#__codelineno-10-30"></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">message</span><span class="p">)</span> <span class="kn">from</span> <span class="kc">None</span>
<a id="__codelineno-10-31" name="__codelineno-10-31" href="#__codelineno-10-31"></a>
<a id="__codelineno-10-32" name="__codelineno-10-32" href="#__codelineno-10-32"></a>    <span class="nd">@validator</span><span class="p">(</span><span class="s2">&quot;hosts&quot;</span><span class="p">,</span> <span class="n">each_item</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-10-33" name="__codelineno-10-33" href="#__codelineno-10-33"></a>    <span class="k">def</span> <span class="nf">hosts_fqdn_must_be_valid</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">v</span><span class="p">):</span>                       <span class="c1"># (2)</span>
<a id="__codelineno-10-34" name="__codelineno-10-34" href="#__codelineno-10-34"></a>        <span class="bp">cls</span><span class="o">.</span><span class="n">validate_hosts_fqdn</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">FQDN_HAS_SLASH_PREFIX</span><span class="p">)</span>
<a id="__codelineno-10-35" name="__codelineno-10-35" href="#__codelineno-10-35"></a>        <span class="bp">cls</span><span class="o">.</span><span class="n">validate_hosts_fqdn</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">DISALLOW_URL_SCHEMA</span><span class="p">)</span>
<a id="__codelineno-10-36" name="__codelineno-10-36" href="#__codelineno-10-36"></a>        <span class="bp">cls</span><span class="o">.</span><span class="n">validate_hosts_fqdn</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">FQDN_DOMAIN_LABEL_CONSTRAINTS</span><span class="p">)</span>
<a id="__codelineno-10-37" name="__codelineno-10-37" href="#__codelineno-10-37"></a>        <span class="bp">cls</span><span class="o">.</span><span class="n">validate_hosts_fqdn</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">FQDN_CHARACTER_LENGTH</span><span class="p">)</span>
<a id="__codelineno-10-38" name="__codelineno-10-38" href="#__codelineno-10-38"></a>        <span class="bp">cls</span><span class="o">.</span><span class="n">validate_hosts_fqdn</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">FQDN_DOMAIN_LABEL_CHARACTER_LENGTH</span><span class="p">)</span>
<a id="__codelineno-10-39" name="__codelineno-10-39" href="#__codelineno-10-39"></a>        <span class="bp">cls</span><span class="o">.</span><span class="n">validate_hosts_fqdn</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">TLD_NUMERIC_CONSTRAINTS</span><span class="p">)</span>
<a id="__codelineno-10-40" name="__codelineno-10-40" href="#__codelineno-10-40"></a>        <span class="k">if</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="s2">&quot;^external\/.+$&quot;</span><span class="p">,</span> <span class="n">v</span><span class="p">):</span>
<a id="__codelineno-10-41" name="__codelineno-10-41" href="#__codelineno-10-41"></a>            <span class="bp">cls</span><span class="o">.</span><span class="n">validate_hosts_fqdn</span><span class="p">(</span>
<a id="__codelineno-10-42" name="__codelineno-10-42" href="#__codelineno-10-42"></a>                <span class="n">v</span><span class="p">,</span> <span class="n">EXTERNAL_SLASHED_FQDN_HAS_SERVICE_AND_NAMESPACE_DOMAIN_LABELS</span><span class="p">,</span> <span class="n">assert_not</span><span class="o">=</span><span class="kc">True</span>
<a id="__codelineno-10-43" name="__codelineno-10-43" href="#__codelineno-10-43"></a>            <span class="p">)</span>
<a id="__codelineno-10-44" name="__codelineno-10-44" href="#__codelineno-10-44"></a>            <span class="bp">cls</span><span class="o">.</span><span class="n">validate_hosts_fqdn</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">EXTERNAL_SLASHED_FQDN_HAS_CLUSTER_DNS_SUFFIX</span><span class="p">)</span>
<a id="__codelineno-10-45" name="__codelineno-10-45" href="#__codelineno-10-45"></a>
<a id="__codelineno-10-46" name="__codelineno-10-46" href="#__codelineno-10-46"></a>        <span class="k">return</span> <span class="n">v</span>
</code></pre></div>
<ol>
<li>The <code>validate_hosts_fqdn</code> static method receives the scenario as input, then asserts whether the regex pattern matches, and if it doesn't, it raises a <code>ValueError</code>.  During processing, pydantic raises a <code>ValidationError</code>, so the unit tests cases must reflect that.</li>
<li>The <code>hosts_fqdn_must_be_valid</code> validator method runs through all scenarios, and raises a <code>ValidationError</code> for each invalid <code>hosts</code> entry, so multiple invalid entries return multiple <code>ValidationError</code>s</li>
</ol>
<p>Custom resources with <code>hosts</code> entries will now be validated, and the CRD controller error messages should now be eliminated.</p>
<h2 id="conclusion">Conclusion</h2>
<p>While primiarily used to integrate with openapi-compliant web frameworks like fastapi, Pydantic is a fantastic tool to use for CRD schema validation as well.  </p>

  
  




  



      
    </article>
  </div>

          
  <script>var tabs=__md_get("__tabs");if(Array.isArray(tabs))e:for(var set of document.querySelectorAll(".tabbed-set")){var tab,labels=set.querySelector(".tabbed-labels");for(tab of tabs)for(var label of labels.getElementsByTagName("label"))if(label.innerText.trim()===tab){var input=document.getElementById(label.htmlFor);input.checked=!0;continue e}}</script>

<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
          <button type="button" class="md-top md-icon" data-md-component="top" hidden>
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8v12Z"/></svg>
            Back to top
          </button>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
    <div class="md-copyright__highlight">
      &copy; 2023 <a href="https://github.com/jonathanelbailey"  target="_blank" rel="noopener">Jonathan Bailey</a>
    </div>
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs Insiders
    </a>
  
</div>
      
        <div class="md-social">
  
    
    
    
    
      
      
    
    <a href="https://github.com/jonathanelbailey" target="_blank" rel="noopener" title="github.com" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 480 512"><!--! Font Awesome Free 6.4.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M186.1 328.7c0 20.9-10.9 55.1-36.7 55.1s-36.7-34.2-36.7-55.1 10.9-55.1 36.7-55.1 36.7 34.2 36.7 55.1zM480 278.2c0 31.9-3.2 65.7-17.5 95-37.9 76.6-142.1 74.8-216.7 74.8-75.8 0-186.2 2.7-225.6-74.8-14.6-29-20.2-63.1-20.2-95 0-41.9 13.9-81.5 41.5-113.6-5.2-15.8-7.7-32.4-7.7-48.8 0-21.5 4.9-32.3 14.6-51.8 45.3 0 74.3 9 108.8 36 29-6.9 58.8-10 88.7-10 27 0 54.2 2.9 80.4 9.2 34-26.7 63-35.2 107.8-35.2 9.8 19.5 14.6 30.3 14.6 51.8 0 16.4-2.6 32.7-7.7 48.2 27.5 32.4 39 72.3 39 114.2zm-64.3 50.5c0-43.9-26.7-82.6-73.5-82.6-18.9 0-37 3.4-56 6-14.9 2.3-29.8 3.2-45.1 3.2-15.2 0-30.1-.9-45.1-3.2-18.7-2.6-37-6-56-6-46.8 0-73.5 38.7-73.5 82.6 0 87.8 80.4 101.3 150.4 101.3h48.2c70.3 0 150.6-13.4 150.6-101.3zm-82.6-55.1c-25.8 0-36.7 34.2-36.7 55.1s10.9 55.1 36.7 55.1 36.7-34.2 36.7-55.1-10.9-55.1-36.7-55.1z"/></svg>
    </a>
  
    
    
    
    
      
      
    
    <a href="https://www.linkedin.com/in/jonathanedwardleebailey/" target="_blank" rel="noopener" title="www.linkedin.com" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.4.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M416 32H31.9C14.3 32 0 46.5 0 64.3v383.4C0 465.5 14.3 480 31.9 480H416c17.6 0 32-14.5 32-32.3V64.3c0-17.8-14.4-32.3-32-32.3zM135.4 416H69V202.2h66.5V416zm-33.2-243c-21.3 0-38.5-17.3-38.5-38.5S80.9 96 102.2 96c21.2 0 38.5 17.3 38.5 38.5 0 21.3-17.2 38.5-38.5 38.5zm282.1 243h-66.4V312c0-24.8-.5-56.7-34.5-56.7-34.6 0-39.9 27-39.9 54.9V416h-66.4V202.2h63.7v29.2h.9c8.9-16.8 30.6-34.5 62.9-34.5 67.2 0 79.7 44.3 79.7 101.9V416z"/></svg>
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    <script id="__config" type="application/json">{"base": "../../../..", "features": ["navigation.tabs", "navigation.sections", "toc.integrate", "navigation.top", "search.suggest", "search.highlight", "content.tabs.link", "content.code.annotation", "content.code.copy", "content.code.annotate"], "search": "../../../../assets/javascripts/workers/search.6c7302c4.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}}</script>
    
    
      <script src="../../../../assets/javascripts/bundle.7001d404.min.js"></script>
      
    
  <script>document$.subscribe(() => {const lightbox = GLightbox({"touchNavigation": true, "loop": false, "zoomable": true, "draggable": true, "openEffect": "zoom", "closeEffect": "zoom", "slideEffect": "slide"});})</script></body>
</html>